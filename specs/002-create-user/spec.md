# Feature Specification: 用户管理与认证模块

**Feature Branch**: `002-create-user`  
**Created**: 2025-11-08  
**Status**: Draft  
**Input**: User description: "我们开始创建第一个业务模块，你首先掌握@definition-of-terms.md的基本术语，然后制定用户管理模块的规范，采取循序渐进策略逐步开发完善用户管理的功能。当前只需要实现简单的创建新用户需求。业务模块开发遵循DDD+Clean Architecuture开发规范。领域实体按“充血模型”开发" + "综合上述评估内容增加认证（auth）模块"

> **注意**：规格说明必须使用中文撰写，并在每一处公共 API 描述中同步计划编写 TSDoc 注释和中文错误消息。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 平台管理员创建租户用户 (Priority: P1)

平台管理员（参照《术语定义》中的“平台”角色）在租户 onboarding 流程中，需要为某一租户手动创建首个租户管理员账户，以便后续交接。

**Why this priority**: 没有首个租户用户，租户无法登陆系统继续自助配置，阻塞业务接入流程。

**Independent Test**: 可独立通过调用“创建用户”用例，验证在无既有用户情况下仍能完成账户创建并获得唯一用户编号。

**Acceptance Scenarios**:

1. **Given** 平台管理员已通过平台认证并选择目标租户，**When** 管理员填写合法的姓名、邮箱、手机号并提交创建请求，**Then** 系统返回成功结果，包含新用户的唯一标识、初始状态为“待激活”，并记录中文操作日志。
2. **Given** 平台管理员尝试使用平台内已存在的邮箱地址（无论所属租户），**When** 发起创建请求，**Then** 系统拒绝并返回中文错误消息“邮箱已被占用”，同时不写入任何部分数据。
3. **Given** 平台管理员填写的手机号格式非法，**When** 发起创建请求，**Then** 系统拒绝创建并提示中文错误“手机号格式不正确”，校验结果记录在领域事件日志中。

### User Story 2 - 平台管理员登录并获取访问令牌 (Priority: P1)

平台管理员需要通过统一认证入口登录平台，系统需颁发访问令牌（Access Token）与刷新令牌（Refresh Token），并在后续 API 请求中基于 CASL 策略完成授权校验。

**Why this priority**: 没有统一认证与授权机制，无法保障后续用户管理、租户管理等模块的安全访问；CASL 能力可复用在多租户权限细粒度控制。

**Independent Test**: 通过集成测试模拟“登录 → 获取令牌 → 使用令牌访问受保护接口 → 验证 CASL 权限”的闭环流程，确保登录成功、权限不足、刷新令牌等场景可独立验证。

**Acceptance Scenarios**:

1. **Given** 平台管理员提供正确的邮箱与密码，**When** 调用登录接口，**Then** 返回包含访问令牌、刷新令牌、令牌过期时间与中文提示的成功响应。
2. **Given** 平台管理员提供错误的凭证，**When** 调用登录接口，**Then** 系统返回 401 与中文错误“登录凭证无效”，并记录安全日志。
3. **Given** 平台管理员登录成功后调用受保护接口，**When** 缺少 CASL 所需权限，**Then** 返回 403、中文错误“无权访问当前资源”，并保留访问审计记录。
4. **Given** 平台管理员使用有效刷新令牌，**When** 调用刷新接口，**Then** 返回新的访问令牌与刷新令牌；若刷新令牌已过期或被吊销，**Then** 返回 401 并提示“刷新令牌无效或已过期”。

### Edge Cases

- 在平台管理员缺少租户上下文时（未选择租户或租户状态为停用），系统必须阻止创建并返回中文错误“未选择有效租户”。
- 当请求体缺失必填字段或字段为空字符串时，系统必须统一返回中文错误“用户信息填写不完整”，同时记录 `@hl8/logger` 的警告日志。
- 若并发请求导致平台范围的唯一性冲突（邮箱或手机号），系统需要在领域层捕获异常并返回稳定的中文错误“联系方式已存在”，避免重复创建。
- 当访问令牌过期或被篡改时，系统必须统一抛出中文错误“访问令牌无效”，并在 CLS 中写入告警日志；刷新令牌重复使用时需立即吊销相关会话。
- 多租户场景下，若 CASL 策略检查失败（例如用户不属于目标租户），系统需返回中文错误“无权访问其他租户数据”，并记录租户 ID、用户 ID 于 CLS。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**：系统必须提供“创建租户用户”用例，允许平台管理员在指定租户下创建新用户，所有公共接口需提供中文 TSDoc 注释及错误消息。
- **FR-002**：领域实体 `User` 以充血模型实现，负责自我校验姓名（非空、长度 ≤ 50）、邮箱（平台全局唯一、符合 RFC 5322 基本格式）、手机号（可选字段，需符合中国大陆手机号模式）。
- **FR-003**：在成功创建用户后，系统必须生成带有用户编码、所属租户 ID、初始状态（待激活）及创建人信息的领域事件，并通过 `@hl8/logger` 记录中文信息日志。
- **FR-004**：若邮箱或手机号与平台内已存在的用户冲突，应用层应捕获领域异常并返回稳定的中文错误响应，同时禁止任何脏数据持久化；首个迭代不触发邀请或加入流程。
- **FR-005**：领域服务必须为新建用户自动分配初始角色集合（默认：租户管理员），规则写入领域层并在 TSDoc 中说明。
- **FR-006**：平台管理员身份通过 `X-Platform-Admin-Id` 请求头传入，缺失时返回中文错误提示，便于与后续认证集成。
- **FR-007**：系统必须提供统一认证接口，接受邮箱+密码登录，并调用 Token 服务颁发访问令牌与刷新令牌；接口需返回中文提示与到期时间。
- **FR-008**：Token 服务必须参考 Softkit 核心实现方式，将访问令牌、刷新令牌生成逻辑拆分为 “TokenBuilder（负责 payload 构造）+ TokenService（负责签名、校验、长度告警）”，日志输出使用 `@hl8/logger`。
- **FR-009**：认证模块需集成 CLS，仿照 softkit/nest 项目在 JWT 策略中加载用户、角色、租户，并将 `tenantId`、`userId`、`jwtPayload` 写入 `@hl8/async-storage`，确保后续请求链路可获取上下文。
- **FR-010**：授权模块需基于 CASL 规则实现：
  - 定义 `Actions`、`Subjects` 枚举与权限实体映射；
  - 提供 `CaslAbilityFactory` 根据用户角色权限生成能力；
  - 提供 `PoliciesGuard` + `@CheckPolicies` 装饰器触发 CASL 校验；
  - `PolicyHandler` 支持函数与类两种形式，便于编写“Own/Any”场景；
  - 所有守卫与策略均需输出中文日志。
- **FR-011**：JWT Guard 需支持 `@SkipAuth` 装饰器（参考 softkit guard），当跳过认证时仍需解析租户或写入 CLS；默认作为全局守卫挂载。
- **FR-012**：认证配置必须通过 `@hl8/config` 定义 `AuthConfig`，并使用 `class-validator` 校验 JWT 秘钥、有效期、Header 名称等字段；支持自定义租户 Header（默认为 `x-tenant-id`）。
- **FR-013**：需提供刷新令牌吊销与多端登录安全策略，包含：刷新令牌长度监控告警、重复使用刷新令牌时立即吊销、通过日志记录潜在异常。
- **FR-014**：所有公共 API、守卫、策略、值对象必须补齐中文 TSDoc 注释，错误消息与日志文本严格遵循中文规范。
- **FR-015**：应用层必须采用 `@nestjs/cqrs` 实现命令（Command）与查询（Query）分离，命令总线写入领域聚合并发布事件，查询总线读取投影模型；所有 Handler 均需具备中文 TSDoc。
- **FR-016**：领域事件（如 `UserCreatedDomainEvent`、`AuthSessionCreatedDomainEvent`）必须写入事件存储（MongoDB），并由事件处理器同步更新读模型投影，确保审计与重放能力；写入失败需有中文警告并回退至内存实现。
- **FR-017**：持久化层需统一使用 MikroORM，命令侧实体落地至 PostgreSQL（支持事务、唯一性约束），事件存储及审计日志使用 MongoDB；配置、迁移、种子流程需在文档中说明。
- **FR-018**：多租户与数据隔离方案必须遵循 `docs/multi-tenant-design.md`，实现 CLS 上下文写入、`TenantEnforceInterceptor`、`TenantAwareSubscriber` 以及 `BaseTenantRepository`；命令、查询 Handler 均需在执行前通过 `TenantContextExecutor` 校验 CLS 中的 `tenantId` 与命令/查询携带的租户一致。
- **FR-019**：命令侧仓储实现必须继承租户感知仓储基类，所有 `find*`、`persist`、`flush`、`nativeUpdate` 调用自动追加 `{ tenant: currentTenant }` 条件；若检测到调用方显式覆盖 `tenant`，需记录安全日志并抛出中文错误“禁止跨租户访问”。
- **FR-020**：查询侧读模型需启用 `tenant` 过滤器，读模型表结构包含 `tenant_id` 复合索引，`QueryHandler` 必须从事件投影元数据读取租户信息并写入 CLS，防止跨租户读取；缺失租户上下文时返回中文错误“缺少租户上下文”。
- **FR-021**：事件溯源、快照与投影器在处理 `UserCreatedDomainEvent` 等事件时，必须携带并校验 `tenantId`，在重建聚合或回放事件过程中发现租户不一致需立即终止并输出中文警告日志。

### Key Entities _(include if feature involves data)_

- **User（用户）**：代表租户范围内的用户身份，关键属性包括 `userId`（平台全局唯一）、`tenantId`、`displayName`、`email`、`mobile`、`status`（活跃、待激活、禁用、锁定、过期）、`roles`（领域内枚举，初期仅包含租户管理员），实体方法负责自我校验与状态变更。
- **Tenant（租户）**：引用自基础模型，用于校验用户必须挂载到有效租户；本特性读取租户标识作为上下文，不改动租户结构。
- **UserCreationRequest（用户创建请求）**：应用层 VO，封装创建所需输入并进行格式校验（如去除前后空格、防止脚本注入），再传递给领域实体构造函数。
- **AuthConfig（认证配置）**：封装访问令牌秘钥、刷新令牌秘钥、过期时间、Header 名称等字段，由 `@hl8/config` 提供；需支持多环境加载与校验。
- **Role（角色）/Permission（权限）**：参考 nestjs-saas boilerplate，将角色与权限实体化，并在角色中维护 `permissions` 列表，用于构建 CASL 能力。
- **TokenPair（令牌对）**：包含访问令牌、刷新令牌、到期时间、颁发时间等；由 Token 服务生成。
- **CaslAbility（能力）**：CASL 生成的能力对象，包含 `Actions` 与 `Subjects` 枚举，用于 PoliciesGuard。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**：平台管理员在收到业务需求后，可在 1 分钟内完成首个租户用户创建（含信息填报与提交），并收到成功提示。
- **SC-002**：同一租户内连续创建 20 个用户时，系统必须确保无重复账号产生，失败情况提供明确中文错误并记录日志。
- **SC-003**：95% 的合法创建请求在 2 秒内完成响应，管理员感知为即时反馈。
- **SC-004**：上线首周，关于“无法创建租户用户”的工单较历史手工处理流程减少 80%。
- **SC-005**：平台管理员登录成功率 ≥ 99%，认证接口 p95 响应时间 ≤ 300ms，刷新令牌接口 p95 ≤ 300ms。
- **SC-006**：所有受保护接口的权限错误必须返回统一中文错误，并在日志中写入用户 ID、租户 ID、权限枚举信息；授权相关日志 100% 覆盖。
- **SC-007**：契约测试覆盖登录、刷新、权限不足等场景，确保 OpenAPI 契约与实现一致；认证与授权相关测试覆盖率 ≥ 85%。

## Assumptions

- 平台管理员已通过平台级认证流程并拥有目标租户的管理权限，权限验证在本特性之外实现；当前迭代聚焦账户创建与认证授权能力搭建。
- 首个版本默认仅支持邮箱与手机号格式校验，不涉及短信或邮件发送；后续通知能力将通过增量特性补充。
- 用户创建后的激活流程（例如邮件激活、初始密码生成）将作为后续特性规划，本次仅创建基础档案与角色信息。
- 登录所需密码暂由外部系统预先设定或通过独立接口初始化；本迭代不实现密码找回流程。
- 权限实体初期以平台管理员权限为主，后续可扩展普通租户用户、组织管理员等角色。
- PostgreSQL 与 MongoDB 通过 Docker Compose 提供本地实例，生产环境需由基础设施团队提供高可用版本；若未启动数据库，可使用内存仓储进行本地开发。
- CQRS 与 ES 实现遵循轻量模式：事件溯源暂不回放重建聚合，仅用于审计与投影更新；后续需要快照/补偿时再扩展。

## Clarifications

### Session 2025-11-08

- Q: 邮箱唯一性是否在平台范围内约束，并且是否需要触发邀请加入流程？ → A: 邮箱需平台全局唯一，当前迭代仅返回错误，不触发邀请或加入。
