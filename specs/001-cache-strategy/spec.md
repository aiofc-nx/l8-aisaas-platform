# Feature Specification: 多层缓存架构方案

**Feature Branch**: `[001-cache-strategy]`  
**Created**: 2025-11-07  
**Status**: Draft  
**Input**: User description: "基于上述你对forks/softkit-core/libs/redis的评价分析，为本SAAS项目提出缓存的设计方案"

> **注意**：规格说明必须使用中文撰写，并在每一处公共 API 描述中同步计划编写 TSDoc 注释和中文错误消息。

## Clarifications

### Session 2025-11-07

- Q: 租户之间缓存部署策略采用单集群命名空间还是独立集群？ → A: 单一 Redis 集群按命名空间隔离
- Q: 写路径主策略采用哪种缓存一致性方案？ → A: 写后双删并发送失效通知

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 平台接口命中缓存 (Priority: P1)

多租户平台接口负责人希望在访问热点租户配置或鉴权数据时命中缓存，避免每次都查询数据库，提高响应速度并保证跨服务一致的键命名规则。

**Why this priority**: 直接影响核心业务接口的响应时间和稳定性，是平台体验与 SLA 的关键指标。

**Independent Test**: 在预生产环境使用模拟租户请求，首次请求命中数据源，后续请求命中缓存且命中率达到设定阈值，同时日志输出符合规范即可独立验收。

**Acceptance Scenarios**:

1. **Given** 缓存策略为只读复制，**When** 同一租户在 1 分钟内重复请求租户信息接口，**Then** 第二次请求开始命中缓存并返回与数据库一致的结果。
2. **Given** 缓存命名策略已配置，**When** 监控查询 CLS 中记录的缓存键，**Then** 键格式符合统一前后缀和分隔符规则且无重复冲突。

---

### User Story 2 - 运维配置缓存策略 (Priority: P2)

运维人员希望通过配置中心一次性下发多实例 Redis 连接、命名空间以及分布式锁参数，并在日志中看到中文提示，确保缓存基础设施可观测、易维护。

**Why this priority**: 平台需支持不同租户隔离和多环境部署，配置灵活性决定上线效率和排障速度。

**Independent Test**: 通过 `@hl8/config` 读取配置，验证必填字段校验、默认值覆盖、错误日志输出中文，并确认 `@hl8/logger` 捕捉到实例初始化记录即可独立验收。

**Acceptance Scenarios**:

1. **Given** 运维提供完整的 Redis 集群配置，**When** 系统启动加载配置类，**Then** 所有字段通过校验且日志提示“缓存客户端初始化成功”。
2. **Given** 运维漏配必填字段，**When** 配置验证执行，**Then** 抛出带中文说明的配置错误消息并阻止模块继续初始化。

---

### User Story 3 - 业务侧控制数据一致性 (Priority: P3)

业务开发希望在写操作成功后及时刷新或失效缓存，并在高并发时依赖分布式锁避免脏写，同时保持接口可测试。

**Why this priority**: 虽非读路径关键，但确保数据一致性与并发安全，减少回源风暴和数据错乱风险。

**Independent Test**: 通过单元测试模拟写操作携带锁，上锁-更新-失效流程结束后读取缓存返回新值，并验证锁释放和日志输出。

**Acceptance Scenarios**:

1. **Given** 某业务调用缓存失效 API，**When** 写操作完成后触发缓存刷新，**Then** 后续读取返回最新值且命中率回升。
2. **Given** 两个并发请求尝试更新同一键，**When** 分布式锁服务生效，**Then** 只有一个请求持有锁执行更新，另一个请求记录中文警告并重试或退出。

### Edge Cases

- 在 Redis 实例短暂不可达时系统如何降级？需要说明退化策略（如回源数据库、快速失败）以及通过 `@hl8/logger` 输出中文错误与恢复提示。
- 遇到缓存键生成参数为空或包含非法字符时系统如何处理？需要记录中文告警、丢弃该键并保留原始请求栈。
- 当分布式锁获取超时或 Redlock 客户端列表不完整时如何响应？必须返回明确的中文错误消息并提示运维检查配置。
- 配置热加载过程中，旧实例如何平滑释放连接且避免请求落到未初始化的客户端？需定义日志与监控指标。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**：系统必须提供统一的缓存配置模型，基于 `@hl8/config` 与 `class-validator` 校验多实例连接、命名空间、公共参数，并输出中文校验错误与 TSDoc 注释；默认支持单集群按命名空间隔离的多租户结构。
- **FR-002**：系统必须支持通过动态模块方式注册缓存客户端，自动导出 Redis 客户端集合，业务模块可依赖注入并在初始化日志中输出中文追踪。
- **FR-003**：系统必须提供抽象的缓存键命名策略基础类，业务方可覆盖前缀、后缀、分隔符，保证所有键生成逻辑可通过单元测试验证。
- **FR-004**：系统必须内置分布式锁模块，读取锁配置、封装 Redlock 使用方式，并在锁获取/释放时输出中文日志以便审计。
- **FR-005**：系统必须暴露缓存操作与命中率的监控钩子，支持记录缓存命中、回源、失效操作，并使用 `@hl8/logger` 输出结构化中文日志。
- **FR-006**：系统必须为写操作提供缓存一致性策略，包括主动失效、延迟双删、可配置的 TTL、可选的事件通知钩子，并在 API 级别提供中文 TSDoc 描述。
- **FR-007**：系统必须提供缓存故障降级策略开关，在实例不可用时快速回源、记录中文错误并触发告警钩子，同时避免请求长时间阻塞。
- **FR-008**：系统必须实现默认写路径为“写前删除 + 写后延迟双删 + 失效通知”流程，允许在配置中调整延迟时间及通知通道，以保持共享集群内的一致性与命中率平衡。

### Key Entities _(include if feature involves data)_

- **CacheConfigurationProfile**: 描述各环境的缓存实例集合、公共参数、命名空间以及日志开关，支持多租户与多地域部署。
- **CacheNamespacePolicy**: 定义业务域的命名规则、TTL 策略、失效策略及监控标签，支撑统一的键管理。
- **CacheConsistencyRule**: 规定写操作后的刷新/失效流程、分布式锁选项、回源策略，用于生成业务侧的缓存管控方案；默认包含延迟双删策略与失效通知配置。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**：平台核心接口在启用缓存后，P95 响应时间相较未启用前下降 30% 以上。
- **SC-002**：缓存命中率在稳定运营一周内保持在 85% 以上，且命中率可通过监控仪表板实时查看。
- **SC-003**：运维在新环境接入缓存配置时，初始化失败率低于 1%，异常均伴随中文错误提示与日志链路。
- **SC-004**：高并发写入场景中，由缓存导致的数据一致性工单环比下降 60%，相关事件具备完整日志追踪。
- **SC-005**：缓存实例不可用时，系统可在 5 秒内切换至回源策略并恢复 90% 以上请求的正常响应。

## Assumptions

- 默认运行模式为单一 Redis 集群按命名空间隔离租户，并通过统一命名策略保证键冲突最小化，如需物理隔离需另行立项。
- 缓存底层仍以 Redis 实例为主，但方案应保留接口以支持未来替换或扩展其他缓存引擎。
- 平台已有统一的监控与告警通道，本方案依赖现有通道承载缓存指标与告警事件。
- 业务模块愿意遵循统一的键命名与锁策略，必要时通过培训或文档确保迁移成本可控。
