# 异常处理培训教程

## 教学目标

- **理解背景**：掌握 `@hl8/exceptions` 在统一错误处理、日志追踪、对外文档上的定位
- **快速上手**：完成模块安装、配置与基本集成，掌握拦截器与装饰器的使用套路
- **深度实践**：结合示例项目实现业务异常、校验异常与 Swagger 文档的统一输出

## 课程安排

| 阶段       | 时长    | 关键内容                                     |
| ---------- | ------- | -------------------------------------------- |
| 理论导入   | 15 分钟 | RFC7807 标准简介、项目章程约束、模块能力总览 |
| 环境配置   | 20 分钟 | 安装依赖、注册异常过滤器、配置全局请求 ID    |
| 功能演示   | 30 分钟 | 业务异常封装、校验异常格式化、Swagger 装饰器 |
| 课堂练习   | 25 分钟 | 扩展自定义异常、编写单元测试、联调日志       |
| 答疑与总结 | 10 分钟 | 常见问题、最佳实践、自检清单                 |

## 教程正文

### 1. 理论导入

1. **统一格式**：所有 HTTP 错误响应符合 RFC7807，字段包括 `type`、`title`、`detail`、`status`、`instance`、`errorCode`、`data`
2. **日志联动**：拦截器通过 `@hl8/logger` 自动记录，高优先级错误会出现在管控面板
3. **文档协同**：Swagger 装饰器保证接口文档与实际返回值同步，减少手工维护成本

> 课堂提示：展示 `libs/infra/exceptions/src/index.ts` 导出内容，让学员了解可复用的组件类别。

### 2. 环境配置

1. 在目标应用安装依赖：
   ```bash
   pnpm add @hl8/exceptions
   ```
2. 在应用入口（如 `main.ts`）注册过滤器：
   ```ts
   app.useGlobalFilters(new AnyExceptionFilter(httpAdapterHost, logger), new HttpExceptionFilter(httpAdapterHost, logger), new ForbiddenExceptionFilter(httpAdapterHost, logger), new NotFoundExceptionFilter(httpAdapterHost, logger));
   ```
3. 确保请求上下文中写入 `requestId`，便于 `resolveRequestId` 捕获；可搭配 `@hl8/async-storage` 实现全链路 ID 传递

### 3. 功能演示

#### 3.1 自定义业务异常

```ts
import { AbstractHttpException } from "@hl8/exceptions";

/**
 * @description 新用户注册异常
 */
export class UserRegistrationException extends AbstractHttpException {
  constructor(username: string) {
    super("用户注册失败", `用户名 ${username} 已存在`, 409, { username }, "USER_DUPLICATED");
  }
}
```

> 演示：在控制器中抛出该异常，查看过滤器统一输出及日志打印。

#### 3.2 校验异常格式化

1. 利用 `GeneralBadRequestException` 封装 `class-validator` 的错误
2. 演示 `responseBodyFormatter` 如何与 `class-validator` 自定义 `ValidationPipe` 输出结合

```ts
throw new GeneralBadRequestException({ field: "email", message: "邮箱格式不正确" }, "请求参数校验失败", "INVALID_EMAIL");
```

#### 3.3 Swagger 装饰器

1. 在控制器方法上使用 `ApiBadRequest("INVALID_EMAIL")`
2. 展示自动生成的 schema 结构，以及错误码枚举如何呈现
3. 推荐组合：`ApiEntityNotFound`、`ApiForbiddenError` 等

### 4. 课堂练习

1. **题目一**：实现 `TenantQuotaExceededException`，要求：
   - 状态码 `429`
   - `data` 中包含 `tenantId` 与 `quota`
   - 编写对应的单元测试，验证 `toErrorResponse`
2. **题目二**：在样例控制器中集成 `ApiOptimisticLock("VERSION_MISMATCH")`，并查看 Swagger 结果
3. **题目三**：通过 `resolveRequestId` 在日志中捕获请求 ID，完成日志截图提交

> 课堂参考答案可在 `docs/examples` 目录中查阅（后续可补充）。

### 5. 自检清单

- [ ] 全局注册了所有必要的异常过滤器
- [ ] 对外异常均继承 `AbstractHttpException`，并提供中文 TSDoc
- [ ] 校验逻辑统一使用 `GeneralBadRequestException`
- [ ] Swagger 文档同步展示常见错误码
- [ ] 单元测试覆盖异常转换、过滤器行为、工具函数
- [ ] Lint 与 Test 均通过 (`pnpm --filter @hl8/exceptions lint:check && pnpm --filter @hl8/exceptions test`)

### 6. 常见问题 FAQ

| 问题               | 原因分析                                | 解决方案                                   |
| ------------------ | --------------------------------------- | ------------------------------------------ |
| 返回结构缺少字段   | 未调用 `toErrorResponse` 或 miss 过滤器 | 确认异常继承关系 & 全局注册                |
| 没有 requestId     | 未写入上下文或未挂载中间件              | 引入 `@hl8/async-storage` 并确保中间件启用 |
| Swagger 无错误说明 | 未使用对应装饰器                        | 引入 `ApiBadRequest` 等装饰器              |
| 日志缺乏上下文     | 未注入 `@hl8/logger`                    | 在过滤器构造函数注入并传递                 |

### 7. 课后作业

1. 在实际项目中为关键接口补齐异常定义与 Swagger 文档
2. 编写一份线上巡检脚本，确认所有接口返回体均包含 `instance` 字段
3. 将异常响应示例同步到客户支持知识库

---

> **注意**：教程内容需根据团队反馈迭代，保持与 `libs/infra/exceptions` 模块版本同步。
