# @hl8/config ä½¿ç”¨æŒ‡å—

**ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç†æ¨¡å— - å®Œæ•´åŸ¹è®­æ•™ç¨‹**

---

## ğŸ“š ç›®å½•

1. [æ¨¡å—ç®€ä»‹](#æ¨¡å—ç®€ä»‹)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [é…ç½®å®šä¹‰](#é…ç½®å®šä¹‰)
5. [é…ç½®åŠ è½½å™¨è¯¦è§£](#é…ç½®åŠ è½½å™¨è¯¦è§£)
6. [å˜é‡æ‰©å±•](#å˜é‡æ‰©å±•)
7. [é…ç½®éªŒè¯](#é…ç½®éªŒè¯)
8. [é…ç½®ç¼“å­˜](#é…ç½®ç¼“å­˜)
9. [å®é™…æ¡ˆä¾‹](#å®é™…æ¡ˆä¾‹)
10. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
11. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
12. [è¿›é˜¶ä¸»é¢˜](#è¿›é˜¶ä¸»é¢˜)

---

## æ¨¡å—ç®€ä»‹

### ä»€ä¹ˆæ˜¯ @hl8/configï¼Ÿ

`@hl8/config` æ˜¯ä¸€ä¸ª**ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç†æ¨¡å—**ï¼Œä¸“ä¸º Node.js å’Œ NestJS åº”ç”¨è®¾è®¡ã€‚

### èŒè´£åˆ’åˆ†

**âš ï¸ é‡è¦æç¤º**ï¼š

`@hl8/config` **å¹¶ä¸çŸ¥é“ä½¿ç”¨è€…çš„é…ç½®éœ€æ±‚**ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªé€šç”¨çš„é…ç½®ç®¡ç†å·¥å…·ã€‚å› æ­¤ï¼š

- âœ… **ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰é…ç½®ç±»** - æ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šä¹‰é…ç½®ç»“æ„
- âœ… **ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰éªŒè¯è§„åˆ™** - ä½¿ç”¨ class-validator è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™
- âœ… **ä½¿ç”¨è€…å¿…é¡»éµå¾ªæŠ€æœ¯è§„èŒƒ** - ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨ï¼Œéµå¾ª class-validator è§„èŒƒ

**`@hl8/config` è´Ÿè´£**ï¼š

- âœ… **è¯»å–é…ç½®æ–‡ä»¶** - ä»æ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹æœåŠ¡ç­‰åŠ è½½é…ç½®
- âœ… **é…ç½®éªŒè¯** - ä½¿ç”¨ class-validator éªŒè¯é…ç½®å®Œæ•´æ€§ï¼ˆåŸºäºä½¿ç”¨è€…å®šä¹‰çš„è§„åˆ™ï¼‰
- âœ… **é…ç½®åˆå¹¶** - æ·±åº¦åˆå¹¶å¤šä¸ªé…ç½®æº
- âœ… **é…ç½®æ³¨å…¥** - å°†é…ç½®æ³¨å†Œä¸º NestJS æä¾›è€…ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥
- âœ… **é…ç½®ç¼“å­˜** - å†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œæå‡æ€§èƒ½

**ä½¿ç”¨è€…è´Ÿè´£**ï¼š

- âœ… **å®šä¹‰é…ç½®ç±»** - ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨å®šä¹‰é…ç½®ç»“æ„
- âœ… **å®šä¹‰éªŒè¯è§„åˆ™** - ä½¿ç”¨ class-validator è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™
- âœ… **éµå¾ªæŠ€æœ¯è§„èŒƒ** - éµå¾ª TypeScript ç±»å’Œ class-validator çš„æŠ€æœ¯è§„èŒƒ
- âœ… **ä½¿ç”¨é…ç½®** - é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨é…ç½®ï¼Œäº«å—ç±»å‹å®‰å…¨

### æ ¸å¿ƒç‰¹æ€§

`@hl8/config` æä¾›äº†ï¼š

- âœ… **å®Œå…¨ç±»å‹å®‰å…¨** - TypeScript ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ + è¿è¡Œæ—¶éªŒè¯
- âœ… **å¤šæ ¼å¼æ”¯æŒ** - JSONã€YAMLã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹é…ç½®
- âœ… **æ™ºèƒ½ fallback** - é…ç½®æ–‡ä»¶ä¼˜å…ˆï¼Œç¯å¢ƒå˜é‡ä½œä¸º fallback
- âœ… **å˜é‡æ‰©å±•** - æ”¯æŒ `${VAR}` å’Œ `${VAR:-DEFAULT}` è¯­æ³•
- âœ… **å¼ºå¤§éªŒè¯** - åŸºäº class-validator çš„é…ç½®éªŒè¯
- âœ… **é…ç½®ç¼“å­˜** - å†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œæå‡æ€§èƒ½

### ä¸ºä»€ä¹ˆéœ€è¦ @hl8/configï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„ç—›ç‚¹**ï¼š

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ - ç±»å‹ä¸å®‰å…¨
const port = process.env.PORT; // string | undefined
const dbPort = parseInt(process.env.DB_PORT || "5432"); // æ‰‹åŠ¨è½¬æ¢
if (!port) throw new Error("PORT is required"); // æ‰‹åŠ¨éªŒè¯
```

**ä½¿ç”¨ @hl8/config çš„ä¼˜åŠ¿**ï¼š

```typescript
// âœ… ç±»å‹å®‰å…¨ï¼Œè‡ªåŠ¨éªŒè¯
constructor(private readonly config: AppConfig) {}
const port = this.config.PORT; // numberï¼Œç±»å‹æ˜ç¡®
const dbPort = this.config.database.port; // numberï¼Œè‡ªåŠ¨è½¬æ¢
// å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯ï¼Œé…ç½®é”™è¯¯ç«‹å³å‘ç°
```

### é€‚ç”¨åœºæ™¯

- âœ… NestJS åº”ç”¨é…ç½®ç®¡ç†
- âœ… Node.js åº”ç”¨é…ç½®åŠ è½½
- âœ… å¾®æœåŠ¡é…ç½®ä¸­å¿ƒ
- âœ… å¤šç¯å¢ƒé…ç½®ç®¡ç†
- âœ… éœ€è¦ç±»å‹å®‰å…¨çš„é…ç½®

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. TypedConfigModule

`TypedConfigModule` æ˜¯æ ¸å¿ƒæ¨¡å—ï¼Œæä¾›é…ç½®ç®¡ç†åŠŸèƒ½ã€‚

**ä¸¤ç§ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// åŒæ­¥æ–¹å¼ - é€‚ç”¨äºé…ç½®å·²å‡†å¤‡å¥½
TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [...],
})

// å¼‚æ­¥æ–¹å¼ - é€‚ç”¨äºéœ€è¦å¼‚æ­¥åŠ è½½é…ç½®
TypedConfigModule.forRootAsync({
  schema: AppConfig,
  load: [...],
})
```

### 2. é…ç½® Schema

é…ç½® Schema æ˜¯ä¸€ä¸ª TypeScript ç±»ï¼Œä½¿ç”¨è£…é¥°å™¨å®šä¹‰é…ç½®ç»“æ„ï¼š

```typescript
export class AppConfig {
  @IsString()
  @IsNotEmpty()
  public readonly name!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly port!: number;
}
```

### 3. é…ç½®åŠ è½½å™¨ (Loaders)

åŠ è½½å™¨è´Ÿè´£ä»ä¸åŒæ¥æºåŠ è½½é…ç½®ï¼š

- `fileLoader` - ä»æ–‡ä»¶åŠ è½½ï¼ˆJSON/YAMLï¼‰
- `dotenvLoader` - ä»ç¯å¢ƒå˜é‡åŠ è½½
- `directoryLoader` - ä»ç›®å½•æ‰¹é‡åŠ è½½
- `remoteLoader` - ä»è¿œç¨‹æœåŠ¡åŠ è½½

### 4. é…ç½®åŠ è½½é¡ºåº

é…ç½®åŠ è½½å™¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œ**åé¢çš„é…ç½®ä¼šè¦†ç›–å‰é¢çš„**ã€‚æ¨èæŒ‰ç…§ä»¥ä¸‹é¡ºåºåŠ è½½ï¼š

```typescript
load: [
  // 1. é…ç½®æ–‡ä»¶ï¼ˆä¼˜å…ˆï¼‰
  directoryLoader({ directory: "./config" }),
  // 2. è¿œç¨‹é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  // remoteLoader('https://config-server.com/api/config'),
  // 3. ç¯å¢ƒå˜é‡ï¼ˆä½œä¸º fallbackï¼‰
  dotenvLoader({ separator: "__", ignoreEnvFile: true }),
];
```

**åŠ è½½ä¼˜å…ˆçº§**ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **é…ç½®æ–‡ä»¶**ï¼ˆJSON/YAMLï¼‰- ä¼˜å…ˆåŠ è½½
2. **è¿œç¨‹é…ç½®æº** - å¦‚æœé…ç½®äº†è¿œç¨‹é…ç½®æœåŠ¡
3. **è¿›ç¨‹ç¯å¢ƒå˜é‡** - ä½œä¸ºæœ€åçš„ fallback
4. **.env æ–‡ä»¶** - ä»…åœ¨æ— æ³•è·å¾—å…¶ä»–é…ç½®æºæ—¶ä½¿ç”¨

**é‡è¦è¯´æ˜**ï¼š

- é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä¼šç»§ç»­å°è¯•å…¶ä»–é…ç½®æº
- `.env` æ–‡ä»¶åªåœ¨æ²¡æœ‰å…¶ä»–é…ç½®æºæ—¶ä½œä¸º fallback
- `.env` æ–‡ä»¶ä¸å­˜åœ¨æ—¶é™é»˜å¿½ç•¥ï¼Œä¸ä¼šå½±å“åº”ç”¨å¯åŠ¨

---

## å¿«é€Ÿå¼€å§‹

### èŒè´£åˆ’åˆ†è¯´æ˜

åœ¨ä½¿ç”¨ `@hl8/config` ä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®èŒè´£åˆ’åˆ†ï¼š

- **`@hl8/config`**ï¼šè´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ã€éªŒè¯é…ç½®ã€åˆå¹¶é…ç½®ã€æ³¨å…¥é…ç½®
- **ä½¿ç”¨è€…**ï¼šè´Ÿè´£å®šä¹‰é…ç½®ç±»ã€å®šä¹‰éªŒè¯è§„åˆ™ã€ä½¿ç”¨é…ç½®

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

```bash
pnpm add @hl8/config
```

### æ­¥éª¤ 2: å®šä¹‰é…ç½®ç±»ï¼ˆä½¿ç”¨è€…è´Ÿè´£ï¼‰

åˆ›å»º `src/config/app.config.ts`ï¼š

**æ³¨æ„**ï¼šé…ç½®ç±»ç”±ä½¿ç”¨è€…å®šä¹‰ï¼Œ`@hl8/config` åªè´Ÿè´£è¯»å–å’ŒéªŒè¯ã€‚

```typescript
import { Type } from "class-transformer";
import { IsNumber, IsString, ValidateNested } from "class-validator";

export class DatabaseConfig {
  @IsString()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly port!: number;

  @IsString()
  public readonly name!: string;
}

export class AppConfig {
  @IsString()
  public readonly NODE_ENV!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly PORT!: number;

  @ValidateNested()
  @Type(() => DatabaseConfig)
  public readonly database!: DatabaseConfig;
}
```

### æ­¥éª¤ 3: é…ç½®æ¨¡å—ï¼ˆ@hl8/config è´Ÿè´£è¯»å–ï¼‰

åœ¨ `app.module.ts` ä¸­å¯¼å…¥ `TypedConfigModule`ï¼š

**æ³¨æ„**ï¼š`@hl8/config` è´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨è€…åªéœ€è¦æä¾›é…ç½®ç±»å’ŒåŠ è½½å™¨é…ç½®ã€‚

```typescript
import { TypedConfigModule, dotenvLoader } from "@hl8/config";
import { Module } from "@nestjs/common";
import { AppConfig } from "./config/app.config.js";

@Module({
  imports: [
    TypedConfigModule.forRoot({
      schema: AppConfig,
      isGlobal: true, // å…¨å±€æ¨¡å—ï¼Œå…¶ä»–æ¨¡å—å¯ç›´æ¥ä½¿ç”¨
      load: [
        dotenvLoader({
          separator: "__", // åµŒå¥—åˆ†éš”ç¬¦
          enableExpandVariables: true, // å¯ç”¨å˜é‡æ‰©å±•
        }),
      ],
    }),
  ],
})
export class AppModule {}
```

### æ­¥éª¤ 4: ä½¿ç”¨é…ç½®ï¼ˆä½¿ç”¨è€…è´Ÿè´£ï¼‰

åœ¨æœåŠ¡æˆ–æ§åˆ¶å™¨ä¸­é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨é…ç½®ï¼š

**æ³¨æ„**ï¼šé…ç½®å·²ç»ç”± `@hl8/config` è¯»å–ã€éªŒè¯å¹¶æ³¨å†Œä¸º NestJS æä¾›è€…ï¼Œä½¿ç”¨è€…ç›´æ¥æ³¨å…¥å³å¯ã€‚

```typescript
import { Injectable } from "@nestjs/common";
import { AppConfig } from "./config/app.config.js";

@Injectable()
export class DatabaseService {
  constructor(private readonly config: AppConfig) {}

  connect() {
    // å®Œå…¨ç±»å‹å®‰å…¨ï¼Œè‡ªåŠ¨è¡¥å…¨
    console.log(`è¿æ¥åˆ° ${this.config.database.host}:${this.config.database.port}`);
  }
}
```

**å®Œæˆï¼** ç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥ `AppConfig` å¹¶ä½¿ç”¨ç±»å‹å®‰å…¨çš„é…ç½®ã€‚

### èŒè´£æ€»ç»“

| èŒè´£             | è´Ÿè´£æ–¹          | è¯´æ˜                                         |
| ---------------- | --------------- | -------------------------------------------- |
| **å®šä¹‰é…ç½®ç±»**   | **ä½¿ç”¨è€…**      | ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨å®šä¹‰é…ç½®ç»“æ„       |
| **è¯»å–é…ç½®æ–‡ä»¶** | **@hl8/config** | é€šè¿‡åŠ è½½å™¨ä»æ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹æœåŠ¡è¯»å– |
| **é…ç½®éªŒè¯**     | **@hl8/config** | ä½¿ç”¨ class-validator éªŒè¯é…ç½®å®Œæ•´æ€§          |
| **é…ç½®åˆå¹¶**     | **@hl8/config** | æ·±åº¦åˆå¹¶å¤šä¸ªé…ç½®æº                           |
| **é…ç½®æ³¨å…¥**     | **@hl8/config** | å°†é…ç½®æ³¨å†Œä¸º NestJS æä¾›è€…                   |
| **ä½¿ç”¨é…ç½®**     | **ä½¿ç”¨è€…**      | é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨é…ç½®ï¼Œäº«å—ç±»å‹å®‰å…¨           |

**æ ¸å¿ƒè¦ç‚¹**ï¼š

- âœ… `@hl8/config` è´Ÿè´£**è¯»å–é…ç½®æ–‡ä»¶**
- âœ… ä½¿ç”¨è€…è´Ÿè´£**å®šä¹‰é…ç½®ç±»**å’Œ**å®šä¹‰éªŒè¯è§„åˆ™**
- âš ï¸ **`@hl8/config` å¹¶ä¸çŸ¥é“ä½¿ç”¨è€…çš„é…ç½®éœ€æ±‚**ï¼Œä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰é…ç½®ç±»å’ŒéªŒè¯è§„åˆ™

### é…ç½®ç±»å®šä¹‰æŠ€æœ¯è§„èŒƒæ€»ç»“

åœ¨ä½¿ç”¨ `@hl8/config` ä¹‹å‰ï¼Œä½¿ç”¨è€…å¿…é¡»éµå¾ªä»¥ä¸‹æŠ€æœ¯è§„èŒƒå®šä¹‰é…ç½®ç±»ï¼š

| æŠ€æœ¯è§„èŒƒ                     | è¯´æ˜                                              | ç¤ºä¾‹                                                 |
| ---------------------------- | ------------------------------------------------- | ---------------------------------------------------- |
| **TypeScript ç±»**            | é…ç½®ç±»å¿…é¡»æ˜¯ TypeScript class                     | `export class AppConfig {}`                          |
| **class-validator è£…é¥°å™¨**   | ä½¿ç”¨è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™                            | `@IsString()`, `@IsNumber()`, `@IsOptional()`        |
| **class-transformer è£…é¥°å™¨** | ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œç±»å‹è½¬æ¢                            | `@Type(() => Number)`, `@Type(() => DatabaseConfig)` |
| **readonly ä¿®é¥°ç¬¦**          | é…ç½®å±æ€§ä½¿ç”¨ readonly ç¡®ä¿ä¸å¯å˜                  | `public readonly port!: number;`                     |
| **éç©ºæ–­è¨€**                 | ä½¿ç”¨ `!` å‘Šè¯‰ TypeScript å±æ€§ä¼šè¢«åˆå§‹åŒ–           | `public readonly port!: number;`                     |
| **åµŒå¥—é…ç½®**                 | åµŒå¥—é…ç½®å¿…é¡»ä½¿ç”¨ `@ValidateNested()` å’Œ `@Type()` | `@ValidateNested() @Type(() => DatabaseConfig)`      |

**è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ[é…ç½®å®šä¹‰](#é…ç½®å®šä¹‰)ç« èŠ‚**ã€‚

### æ­¥éª¤ 5: åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
NODE_ENV=development
PORT=3000
DATABASE__HOST=localhost
DATABASE__PORT=5432
DATABASE__NAME=mydb
```

**å®Œæˆï¼** ç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥ `AppConfig` å¹¶ä½¿ç”¨ç±»å‹å®‰å…¨çš„é…ç½®ã€‚

---

## é…ç½®å®šä¹‰

**âš ï¸ é‡è¦æç¤º**ï¼š

`@hl8/config` **å¹¶ä¸çŸ¥é“ä½¿ç”¨è€…çš„é…ç½®éœ€æ±‚**ï¼Œå› æ­¤ï¼š

- âœ… **ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰é…ç½®ç±»** - æ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šä¹‰é…ç½®ç»“æ„
- âœ… **ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰éªŒè¯è§„åˆ™** - ä½¿ç”¨ class-validator è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™
- âœ… **ä½¿ç”¨è€…å¿…é¡»éµå¾ªæŠ€æœ¯è§„èŒƒ** - ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨ï¼Œéµå¾ª class-validator è§„èŒƒ

`@hl8/config` åªè´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ã€éªŒè¯é…ç½®ï¼ˆåŸºäºä½¿ç”¨è€…å®šä¹‰çš„è§„åˆ™ï¼‰ã€åˆå¹¶é…ç½®å’Œæ³¨å…¥é…ç½®ã€‚

### é…ç½®ç±»å®šä¹‰æŠ€æœ¯è§„èŒƒ

é…ç½®ç±»å¿…é¡»éµå¾ªä»¥ä¸‹æŠ€æœ¯è§„èŒƒï¼š

1. **ä½¿ç”¨ TypeScript ç±»** - é…ç½®ç±»å¿…é¡»æ˜¯ TypeScript class
2. **ä½¿ç”¨ class-validator è£…é¥°å™¨** - ä½¿ç”¨ `@IsString()`, `@IsNumber()`, `@IsOptional()` ç­‰è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™
3. **ä½¿ç”¨ class-transformer è£…é¥°å™¨** - ä½¿ç”¨ `@Type()` è£…é¥°å™¨è¿›è¡Œç±»å‹è½¬æ¢
4. **ä½¿ç”¨ readonly ä¿®é¥°ç¬¦** - é…ç½®å±æ€§åº”è¯¥ä½¿ç”¨ `readonly` ä¿®é¥°ç¬¦ï¼Œç¡®ä¿é…ç½®ä¸å¯å˜
5. **ä½¿ç”¨éç©ºæ–­è¨€** - ä½¿ç”¨ `!` éç©ºæ–­è¨€ï¼Œå‘Šè¯‰ TypeScript è¯¥å±æ€§ä¼šè¢«åˆå§‹åŒ–

### åŸºç¡€é…ç½®ç±»ç¤ºä¾‹

é…ç½®ç±»ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨å®šä¹‰ï¼Œç”±ä½¿ç”¨è€…è´Ÿè´£ç¼–å†™ã€‚

```typescript
// é…ç½®ç±»å®šä¹‰æŠ€æœ¯è§„èŒƒï¼š
// 1. ä½¿ç”¨ TypeScript ç±»
// 2. ä½¿ç”¨ class-validator è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™ï¼ˆä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰ï¼‰
// 3. ä½¿ç”¨ class-transformer è£…é¥°å™¨è¿›è¡Œç±»å‹è½¬æ¢
// 4. ä½¿ç”¨ readonly ä¿®é¥°ç¬¦ç¡®ä¿é…ç½®ä¸å¯å˜
// 5. ä½¿ç”¨éç©ºæ–­è¨€ (!) å‘Šè¯‰ TypeScript å±æ€§ä¼šè¢«åˆå§‹åŒ–

import { IsString, IsNumber } from "class-validator";
import { Type } from "class-transformer";

export class AppConfig {
  // å­—ç¬¦ä¸²ç±»å‹é…ç½®
  @IsString() // éªŒè¯è§„åˆ™ï¼šå¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼ˆä½¿ç”¨è€…å®šä¹‰ï¼‰
  public readonly name!: string; // readonly ç¡®ä¿ä¸å¯å˜ï¼Œ! éç©ºæ–­è¨€

  // æ•°å­—ç±»å‹é…ç½®ï¼ˆéœ€è¦ç±»å‹è½¬æ¢ï¼‰
  @IsNumber() // éªŒè¯è§„åˆ™ï¼šå¿…é¡»æ˜¯æ•°å­—ï¼ˆä½¿ç”¨è€…å®šä¹‰ï¼‰
  @Type(() => Number) // ç±»å‹è½¬æ¢ï¼šä»å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—ï¼ˆç¯å¢ƒå˜é‡é»˜è®¤æ˜¯å­—ç¬¦ä¸²ï¼‰
  public readonly port!: number; // readonly ç¡®ä¿ä¸å¯å˜ï¼Œ! éç©ºæ–­è¨€
}
```

**æŠ€æœ¯è§„èŒƒè¯´æ˜**ï¼š

1. **`@IsString()`** - class-validator è£…é¥°å™¨ï¼ŒéªŒè¯å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼ˆ**ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰**ï¼‰
2. **`@IsNumber()`** - class-validator è£…é¥°å™¨ï¼ŒéªŒè¯å€¼å¿…é¡»æ˜¯æ•°å­—ï¼ˆ**ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰**ï¼‰
3. **`@Type(() => Number)`** - class-transformer è£…é¥°å™¨ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—ï¼ˆç¯å¢ƒå˜é‡é»˜è®¤æ˜¯å­—ç¬¦ä¸²ï¼‰
4. **`readonly`** - TypeScript ä¿®é¥°ç¬¦ï¼Œç¡®ä¿é…ç½®å±æ€§ä¸å¯å˜
5. **`!`** - TypeScript éç©ºæ–­è¨€ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨è¯¥å±æ€§ä¼šè¢«åˆå§‹åŒ–ï¼ˆç”± @hl8/config è´Ÿè´£ï¼‰

### åµŒå¥—é…ç½®

```typescript
export class DatabaseConfig {
  @IsString()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly port!: number;
}

export class AppConfig {
  @ValidateNested() // éªŒè¯åµŒå¥—å¯¹è±¡
  @Type(() => DatabaseConfig) // ç±»å‹è½¬æ¢
  public readonly database!: DatabaseConfig;
}
```

### å¯é€‰é…ç½®

```typescript
export class AppConfig {
  @IsString()
  @IsOptional() // æ ‡è®°ä¸ºå¯é€‰
  public readonly optionalField?: string;

  @IsNumber()
  @Type(() => Number)
  @IsOptional()
  public readonly optionalNumber?: number;
}
```

### é»˜è®¤å€¼

```typescript
export class AppConfig {
  @IsString()
  @IsOptional()
  public readonly NODE_ENV: string = "development"; // é»˜è®¤å€¼

  @IsNumber()
  @Type(() => Number)
  @IsOptional()
  public readonly PORT: number = 3000; // é»˜è®¤å€¼
}
```

### æ•°ç»„é…ç½®

```typescript
export class AppConfig {
  @IsArray()
  @IsString({ each: true }) // éªŒè¯æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ 
  public readonly allowedOrigins!: string[];
}
```

### æšä¸¾é…ç½®

```typescript
enum LogLevel {
  DEBUG = "debug",
  INFO = "info",
  WARN = "warn",
  ERROR = "error",
}

export class AppConfig {
  @IsEnum(LogLevel)
  public readonly logLevel!: LogLevel;
}
```

### å¸¸ç”¨éªŒè¯è£…é¥°å™¨

| è£…é¥°å™¨          | è¯´æ˜           | ç¤ºä¾‹                     |
| --------------- | -------------- | ------------------------ |
| `@IsString()`   | å¿…é¡»æ˜¯å­—ç¬¦ä¸²   | `@IsString()`            |
| `@IsNumber()`   | å¿…é¡»æ˜¯æ•°å­—     | `@IsNumber()`            |
| `@IsBoolean()`  | å¿…é¡»æ˜¯å¸ƒå°”å€¼   | `@IsBoolean()`           |
| `@IsArray()`    | å¿…é¡»æ˜¯æ•°ç»„     | `@IsArray()`             |
| `@IsOptional()` | å¯é€‰å­—æ®µ       | `@IsOptional()`          |
| `@IsNotEmpty()` | éç©º           | `@IsNotEmpty()`          |
| `@Min(n)`       | æœ€å°å€¼         | `@Min(1)`                |
| `@Max(n)`       | æœ€å¤§å€¼         | `@Max(65535)`            |
| `@IsIn([...])`  | å€¼å¿…é¡»åœ¨åˆ—è¡¨ä¸­ | `@IsIn(['dev', 'prod'])` |
| `@IsUrl()`      | å¿…é¡»æ˜¯ URL     | `@IsUrl()`               |
| `@IsEmail()`    | å¿…é¡»æ˜¯é‚®ç®±     | `@IsEmail()`             |

---

## é…ç½®åŠ è½½å™¨è¯¦è§£

### 1. dotenvLoader - ç¯å¢ƒå˜é‡åŠ è½½å™¨

**ç¯å¢ƒå˜é‡åŠ è½½å™¨**ï¼Œä» `.env` æ–‡ä»¶å’Œè¿›ç¨‹ç¯å¢ƒå˜é‡åŠ è½½é…ç½®ã€‚

#### åŸºç¡€ç”¨æ³•

```typescript
dotenvLoader({
  separator: "__", // åµŒå¥—åˆ†éš”ç¬¦ï¼Œé»˜è®¤ "__"
  enableExpandVariables: true, // å¯ç”¨å˜é‡æ‰©å±•
});
```

#### å®Œæ•´é€‰é¡¹

```typescript
dotenvLoader({
  // .env æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
  envFilePath: ".env",

  // æ˜¯å¦å¿½ç•¥ .env æ–‡ä»¶ï¼ˆåªä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
  // æ¨èï¼šè®¾ç½®ä¸º trueï¼Œä¼˜å…ˆä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œ.env æ–‡ä»¶ä½œä¸º fallback
  ignoreEnvFile: false,

  // æ˜¯å¦å¿½ç•¥ç¯å¢ƒå˜é‡ï¼ˆåªä½¿ç”¨ .env æ–‡ä»¶ï¼‰
  ignoreEnvVars: false,

  // åµŒå¥—é…ç½®åˆ†éš”ç¬¦ï¼ˆé»˜è®¤ "__"ï¼‰
  separator: "__",

  // å¯ç”¨å˜é‡æ‰©å±•ï¼ˆé»˜è®¤ trueï¼‰
  enableExpandVariables: true,

  // é”®è½¬æ¢å™¨ï¼ˆå¯é€‰ï¼‰
  keyTransformer: (key) => key.toLowerCase(),
});
```

**åŠ è½½ç­–ç•¥**ï¼š

- `.env` æ–‡ä»¶ä¸å­˜åœ¨æ—¶é™é»˜å¿½ç•¥ï¼Œä¸ä¼šæŠ¥é”™
- **æ¨èé…ç½®**ï¼šä¼˜å…ˆä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆJSON/YAMLï¼‰å’Œè¿œç¨‹é…ç½®ï¼Œ`.env` æ–‡ä»¶ä½œä¸ºæœ€åçš„ fallback
- å¦‚æœ `ignoreEnvFile: true`ï¼Œåªä½¿ç”¨è¿›ç¨‹ç¯å¢ƒå˜é‡ï¼Œä¸åŠ è½½ `.env` æ–‡ä»¶
- è¿›ç¨‹ç¯å¢ƒå˜é‡å§‹ç»ˆå¯ç”¨ï¼Œä½œä¸ºæœ€åçš„é…ç½®æº

#### ç¯å¢ƒå˜é‡å‘½åè§„åˆ™

ä½¿ç”¨ `__` åˆ†éš”ç¬¦è¡¨ç¤ºåµŒå¥—é…ç½®ï¼š

```bash
# æ‰å¹³é…ç½®
PORT=3000
NODE_ENV=development

# åµŒå¥—é…ç½®ï¼ˆä½¿ç”¨ __ åˆ†éš”ç¬¦ï¼‰
DATABASE__HOST=localhost
DATABASE__PORT=5432
DATABASE__NAME=mydb

# å¤šçº§åµŒå¥—
LOGGING__LEVEL=info
LOGGING__CONTEXT__ENABLED=true
LOGGING__CONTEXT__INCLUDE_REQUEST_DETAILS=true
```

**å¯¹åº”é…ç½®ç»“æ„**ï¼š

```typescript
{
  PORT: 3000,
  NODE_ENV: "development",
  DATABASE: {
    HOST: "localhost",
    PORT: 5432,
    NAME: "mydb"
  },
  LOGGING: {
    LEVEL: "info",
    CONTEXT: {
      ENABLED: true,
      INCLUDE_REQUEST_DETAILS: true
    }
  }
}
```

### 2. fileLoader - æ–‡ä»¶åŠ è½½å™¨

ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½ JSON æˆ– YAML é…ç½®æ–‡ä»¶ã€‚

#### æŒ‡å®šæ–‡ä»¶è·¯å¾„

```typescript
fileLoader({
  path: "./config/app.yml", // æŒ‡å®šæ–‡ä»¶è·¯å¾„
});
```

#### è‡ªåŠ¨æŸ¥æ‰¾æ–‡ä»¶

```typescript
fileLoader({
  basename: "config", // æ–‡ä»¶ååŸºç¡€å
  searchFrom: process.cwd(), // æœç´¢èµ·å§‹ç›®å½•
});
```

è¿™ä¼šæŸ¥æ‰¾ `config.json`ã€`config.yml`ã€`config.yaml`ã€‚

#### å®Œæ•´é€‰é¡¹

```typescript
fileLoader({
  // æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œå¦‚æœæŒ‡å®šåˆ™ç›´æ¥ä½¿ç”¨ï¼‰
  path: "./config/app.yml",

  // æœç´¢èµ·å§‹ç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ process.cwd()ï¼‰
  searchFrom: process.cwd(),

  // æ–‡ä»¶ååŸºç¡€åï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªåŠ¨æŸ¥æ‰¾ï¼‰
  basename: "config",

  // æ˜¯å¦å¿½ç•¥ç¯å¢ƒå˜é‡æ›¿æ¢ï¼ˆå¯é€‰ï¼Œé»˜è®¤ falseï¼‰
  ignoreEnvironmentVariableSubstitution: false,
});
```

#### é…ç½®æ–‡ä»¶ç¤ºä¾‹

**JSON æ ¼å¼** (`config/app.json`):

```json
{
  "NODE_ENV": "development",
  "PORT": 3000,
  "database": {
    "host": "localhost",
    "port": 5432,
    "name": "mydb"
  }
}
```

**YAML æ ¼å¼** (`config/app.yml`):

```yaml
NODE_ENV: development
PORT: 3000
database:
  host: localhost
  port: 5432
  name: mydb
```

### 3. directoryLoader - ç›®å½•æ‰¹é‡åŠ è½½å™¨

ä»ç›®å½•ä¸­æ‰¹é‡åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶ã€‚

#### åŸºç¡€ç”¨æ³•

```typescript
directoryLoader({
  directory: "./config", // ç›®å½•è·¯å¾„
});
```

#### å®Œæ•´é€‰é¡¹

```typescript
directoryLoader({
  // ç›®å½•è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
  directory: "./config",

  // æ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ /\.(json|yml|yaml)$/ï¼‰
  include: /\.(json|yml|yaml)$/,

  // æ˜¯å¦å¿½ç•¥ç¯å¢ƒå˜é‡æ›¿æ¢ï¼ˆå¯é€‰ï¼Œé»˜è®¤ falseï¼‰
  ignoreEnvironmentVariableSubstitution: false,

  // æ˜¯å¦ä¸å…è®¸æœªå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤ trueï¼‰
  disallowUndefinedEnvironmentVariables: true,
});
```

**é‡è¦æç¤º**ï¼š

- å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå¯¹è±¡è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
- è¿™æ ·å¯ä»¥è®©å…¶ä»–é…ç½®æºï¼ˆå¦‚è¿œç¨‹é…ç½®ã€ç¯å¢ƒå˜é‡ï¼‰ä½œä¸º fallback
- é€‚ç”¨äºé…ç½®æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨çš„åœºæ™¯

#### ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šå¤šç¯å¢ƒé…ç½®**

```
config/
  â”œâ”€â”€ default.json      # é»˜è®¤é…ç½®
  â”œâ”€â”€ development.json  # å¼€å‘ç¯å¢ƒ
  â”œâ”€â”€ production.json   # ç”Ÿäº§ç¯å¢ƒ
  â””â”€â”€ test.json         # æµ‹è¯•ç¯å¢ƒ
```

```typescript
directoryLoader({
  directory: "./config",
  include: /\.(json|yml|yaml)$/,
});
```

**åœºæ™¯ 2ï¼šæ¨¡å—åŒ–é…ç½®**

```
config/
  â”œâ”€â”€ database.json
  â”œâ”€â”€ redis.json
  â”œâ”€â”€ logging.json
  â””â”€â”€ metrics.json
```

æ‰€æœ‰é…ç½®æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åŠ è½½å¹¶åˆå¹¶ã€‚

**æ³¨æ„**ï¼šå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œ`directoryLoader` è¿”å›ç©ºå¯¹è±¡ï¼Œä¸ä¼šæŠ¥é”™ï¼Œå…è®¸å…¶ä»–é…ç½®æºä½œä¸º fallbackã€‚

### 4. remoteLoader - è¿œç¨‹é…ç½®åŠ è½½å™¨

ä»è¿œç¨‹ HTTP æœåŠ¡åŠ è½½é…ç½®ã€‚

#### åŸºç¡€ç”¨æ³•

```typescript
remoteLoader("https://config-server.com/api/config", {
  requestConfig: {
    headers: { Authorization: "Bearer token" },
  },
});
```

#### å®Œæ•´é€‰é¡¹

```typescript
remoteLoader(
  "https://config-server.com/api/config", // URLï¼ˆå¿…éœ€ï¼‰
  {
    // HTTP è¯·æ±‚é…ç½®
    requestConfig: {
      method: "GET", // HTTP æ–¹æ³•ï¼ˆå¯é€‰ï¼‰
      headers: { Authorization: "Bearer token" }, // è¯·æ±‚å¤´ï¼ˆå¯é€‰ï¼‰
      timeout: 5000, // è¶…æ—¶æ—¶é—´ï¼ˆå¯é€‰ï¼Œæ¯«ç§’ï¼‰
    },

    // å“åº”ç±»å‹ï¼ˆå¯é€‰ï¼Œé»˜è®¤ "json"ï¼‰
    type: "json" | "yaml" | "yml",

    // å“åº”æ˜ å°„å‡½æ•°ï¼ˆå¯é€‰ï¼‰
    mapResponse: (response) => response.data,

    // é‡è¯•æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
    shouldRetry: (response) => response.status !== 200,

    // é‡è¯•æ¬¡æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 3ï¼‰
    retries: 3,

    // é‡è¯•é—´éš”ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 1000 æ¯«ç§’ï¼‰
    retryInterval: 1000,
  },
);
```

#### ä½¿ç”¨åœºæ™¯

- å¾®æœåŠ¡é…ç½®ä¸­å¿ƒ
- åŠ¨æ€é…ç½®æ›´æ–°
- å¤šæœåŠ¡å…±äº«é…ç½®

**æ³¨æ„**ï¼šè¿œç¨‹é…ç½®åŠ è½½å¤±è´¥æ—¶ï¼Œåº”è¯¥ç”±è°ƒç”¨è€…å¤„ç†é”™è¯¯ï¼Œæˆ–ä½¿ç”¨å…¶ä»–é…ç½®æºä½œä¸º fallbackã€‚å»ºè®®åœ¨é…ç½®åŠ è½½é¡ºåºä¸­ï¼Œå°†è¿œç¨‹é…ç½®æ”¾åœ¨é…ç½®æ–‡ä»¶ä¹‹åï¼Œç¯å¢ƒå˜é‡ä¹‹å‰ã€‚

---

## å˜é‡æ‰©å±•

### åŸºç¡€è¯­æ³•

#### `${VAR}` - ç¯å¢ƒå˜é‡æ›¿æ¢

```yaml
# config/app.yml
database:
  host: ${DB_HOST}
  port: ${DB_PORT}
```

```bash
# .env
DB_HOST=localhost
DB_PORT=5432
```

**ç»“æœ**ï¼š

```typescript
config.database.host; // â†’ 'localhost'
config.database.port; // â†’ '5432'
```

#### `${VAR:-DEFAULT}` - é»˜è®¤å€¼è¯­æ³•

```yaml
# config/app.yml
database:
  host: ${DB_HOST:-localhost} # å¦‚æœ DB_HOST ä¸å­˜åœ¨ï¼Œä½¿ç”¨ localhost
  port: ${DB_PORT:-5432} # å¦‚æœ DB_PORT ä¸å­˜åœ¨ï¼Œä½¿ç”¨ 5432
```

### åµŒå¥—å˜é‡å¼•ç”¨

```yaml
# config/app.yml
base_url: ${BASE_URL:-http://localhost}
api_url: ${API_URL:-${BASE_URL}/api} # å¼•ç”¨å…¶ä»–å˜é‡
```

### åœ¨ç¯å¢ƒå˜é‡ä¸­ä½¿ç”¨

```bash
# .env
BASE_URL=http://localhost
API_URL=${BASE_URL}/api
VERSION=1.0.0
FULL_URL=${API_URL}/v${VERSION}
```

### åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨

**JSON æ ¼å¼**ï¼š

```json
{
  "database": {
    "host": "${DB_HOST:-localhost}",
    "port": "${DB_PORT:-5432}",
    "url": "postgres://${DB_HOST}:${DB_PORT}/mydb"
  }
}
```

**YAML æ ¼å¼**ï¼š

```yaml
database:
  host: ${DB_HOST:-localhost}
  port: ${DB_PORT:-5432}
  url: postgres://${DB_HOST}:${DB_PORT}/mydb
```

---

## é…ç½®éªŒè¯

**âš ï¸ é‡è¦æç¤º**ï¼š

`@hl8/config` **å¹¶ä¸çŸ¥é“ä½¿ç”¨è€…çš„é…ç½®éœ€æ±‚**ï¼Œå› æ­¤ï¼š

- âœ… **ä½¿ç”¨è€…å¿…é¡»è‡ªå·±å®šä¹‰éªŒè¯è§„åˆ™** - ä½¿ç”¨ class-validator è£…é¥°å™¨å®šä¹‰éªŒè¯è§„åˆ™
- âœ… **ä½¿ç”¨è€…å¿…é¡»éµå¾ª class-validator æŠ€æœ¯è§„èŒƒ** - å‚è€ƒ [class-validator å®˜æ–¹æ–‡æ¡£](https://github.com/typestack/class-validator)

`@hl8/config` åªè´Ÿè´£æ‰§è¡ŒéªŒè¯ï¼ˆåŸºäºä½¿ç”¨è€…å®šä¹‰çš„è§„åˆ™ï¼‰ï¼ŒéªŒè¯å¤±è´¥æ—¶ä¼šé˜»æ­¢åº”ç”¨å¯åŠ¨ã€‚

### éªŒè¯è£…é¥°å™¨

é…ç½®éªŒè¯åŸºäº `class-validator`ï¼Œæ”¯æŒæ‰€æœ‰éªŒè¯è£…é¥°å™¨ã€‚**æ‰€æœ‰éªŒè¯è§„åˆ™å¿…é¡»ç”±ä½¿ç”¨è€…è‡ªå·±å®šä¹‰**ã€‚

#### åŸºç¡€éªŒè¯

```typescript
import { IsString, IsNumber, IsBoolean, IsOptional } from "class-validator";
import { Type } from "class-transformer";

export class AppConfig {
  @IsString()
  @IsNotEmpty()
  public readonly name!: string;

  @IsNumber()
  @Type(() => Number)
  @Min(1)
  @Max(65535)
  public readonly port!: number;

  @IsBoolean()
  @Type(() => Boolean)
  public readonly enabled!: boolean;
}
```

#### åµŒå¥—éªŒè¯

```typescript
export class DatabaseConfig {
  @IsString()
  @IsNotEmpty()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  @Min(1)
  @Max(65535)
  public readonly port!: number;
}

export class AppConfig {
  @ValidateNested() // éªŒè¯åµŒå¥—å¯¹è±¡
  @Type(() => DatabaseConfig)
  public readonly database!: DatabaseConfig;
}
```

#### æ•°ç»„éªŒè¯

```typescript
export class AppConfig {
  @IsArray()
  @IsString({ each: true }) // éªŒè¯æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ 
  @ArrayMinSize(1)
  public readonly allowedOrigins!: string[];
}
```

#### è‡ªå®šä¹‰éªŒè¯

```typescript
import { ValidatorConstraint, ValidatorConstraintInterface } from "class-validator";

@ValidatorConstraint({ name: "isValidPort", async: false })
class IsValidPortConstraint implements ValidatorConstraintInterface {
  validate(port: number): boolean {
    return port >= 1024 && port <= 65535;
  }

  defaultMessage(): string {
    return "Port must be between 1024 and 65535";
  }
}

export class AppConfig {
  @IsNumber()
  @Type(() => Number)
  @Validate(IsValidPortConstraint)
  public readonly port!: number;
}
```

### éªŒè¯é”™è¯¯å¤„ç†

é…ç½®éªŒè¯å¤±è´¥æ—¶ï¼Œåº”ç”¨å¯åŠ¨ä¼šå¤±è´¥å¹¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```
Error: Configuration validation failed:
  - port: must be a number
  - database.host: must be a string
  - database.port: must be a number conforming to the specified constraints
```

---

## é…ç½®ç¼“å­˜

**âš ï¸ é‡è¦æç¤º**ï¼š

`@hl8/config` çš„ç¼“å­˜æœºåˆ¶æ˜¯**é…ç½®ç¼“å­˜**ï¼Œç”¨äºç¼“å­˜é…ç½®åŠ è½½å’ŒéªŒè¯ç»“æœï¼Œæå‡æ€§èƒ½ã€‚å¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜ï¼Œè‡ªåŠ¨ç®¡ç†ã€‚

### ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜å·¥ä½œæµç¨‹

1. **é…ç½®åŠ è½½** - ä»æ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹æœåŠ¡åŠ è½½é…ç½®
2. **é…ç½®éªŒè¯** - ä½¿ç”¨ class-validator éªŒè¯é…ç½®å®Œæ•´æ€§
3. **ç¼“å­˜å­˜å‚¨** - å°†éªŒè¯åçš„é…ç½®å®ä¾‹å­˜å‚¨åˆ°ç¼“å­˜ä¸­
4. **ç¼“å­˜æŸ¥è¯¢** - åç»­è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è·å–é…ç½®ï¼Œé¿å…é‡å¤åŠ è½½å’ŒéªŒè¯

#### ç¼“å­˜ç­–ç•¥

| ç­–ç•¥       | è¯´æ˜     | é€‚ç”¨åœºæ™¯               | æ€§èƒ½            | æŒä¹…åŒ– |
| ---------- | -------- | ---------------------- | --------------- | ------ |
| **memory** | å†…å­˜ç¼“å­˜ | å¼€å‘ç¯å¢ƒã€å•è¿›ç¨‹åº”ç”¨   | âš¡âš¡âš¡ æœ€å¿«     | âŒ å¦  |
| **file**   | æ–‡ä»¶ç¼“å­˜ | éœ€è¦è·¨è¿›ç¨‹å…±äº«ã€æŒä¹…åŒ– | âš¡âš¡ è¾ƒå¿«       | âœ… æ˜¯  |
| **none**   | æ— ç¼“å­˜   | é…ç½®é¢‘ç¹å˜åŒ–ã€è°ƒè¯•ç¯å¢ƒ | âš¡ æ¯æ¬¡é‡æ–°åŠ è½½ | -      |

#### ç¼“å­˜ç‰¹æ€§

- âœ… **è‡ªåŠ¨è¿‡æœŸ** - æ”¯æŒ TTLï¼ˆTime To Liveï¼‰è‡ªåŠ¨è¿‡æœŸ
- âœ… **LRU æ·˜æ±°** - å†…å­˜ç¼“å­˜æ”¯æŒ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰æ·˜æ±°ç­–ç•¥
- âœ… **ç¼“å­˜ç»Ÿè®¡** - æä¾›å‘½ä¸­ç‡ã€è®¿é—®æ—¶é—´ç­‰ç»Ÿè®¡ä¿¡æ¯
- âœ… **äº‹ä»¶ç›‘å¬** - æ”¯æŒç¼“å­˜å‘½ä¸­ã€æœªå‘½ä¸­ã€è¿‡æœŸç­‰äº‹ä»¶ç›‘å¬
- âœ… **é”®å‰ç¼€** - æ”¯æŒç¼“å­˜é”®å‰ç¼€ï¼Œé¿å…é”®å†²çª
- âœ… **å®Œå…¨é€æ˜** - å¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜ï¼Œè‡ªåŠ¨ç®¡ç†

### ä½¿ç”¨åœºæ™¯

#### 1. è¿œç¨‹é…ç½®ç¼“å­˜

å½“ä½¿ç”¨è¿œç¨‹é…ç½®æœåŠ¡æ—¶ï¼Œç¼“å­˜å¯ä»¥æ˜¾è‘—å‡å°‘ç½‘ç»œè¯·æ±‚ï¼š

```typescript
TypedConfigModule.forRootAsync({
  schema: AppConfig,
  load: [
    remoteLoader("https://config-server.com/api/config", {
      requestConfig: {
        headers: { Authorization: "Bearer token" },
      },
    }),
  ],
  cache: {
    enabled: true,
    strategy: "memory",
    ttl: 3600000, // ç¼“å­˜1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
  },
});
```

**ä¼˜åŠ¿**ï¼š

- âœ… å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæå‡æ€§èƒ½
- âœ… é™ä½è¿œç¨‹é…ç½®æœåŠ¡è´Ÿè½½
- âœ… ç½‘ç»œæ•…éšœæ—¶ä»å¯ä½¿ç”¨ç¼“å­˜é…ç½®

#### 2. æ–‡ä»¶é…ç½®ç¼“å­˜

ç¼“å­˜æ–‡ä»¶é…ç½®çš„è§£æå’ŒéªŒè¯ç»“æœï¼š

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [directoryLoader({ directory: "./config" })],
  cache: {
    enabled: true,
    strategy: "file", // æ–‡ä»¶ç¼“å­˜ï¼Œå¯è·¨è¿›ç¨‹å…±äº«
    cacheDir: "./cache",
    ttl: 1800000, // 30åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
  },
});
```

**ä¼˜åŠ¿**ï¼š

- âœ… é¿å…é‡å¤è§£æ JSON/YAML æ–‡ä»¶
- âœ… é¿å…é‡å¤éªŒè¯é…ç½®
- âœ… è·¨è¿›ç¨‹å…±äº«ç¼“å­˜

#### 3. å¼€å‘ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–

åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨å†…å­˜ç¼“å­˜æå‡å¼€å‘ä½“éªŒï¼š

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [fileLoader({ path: "./config/app.yml" })],
  cache: {
    enabled: process.env.NODE_ENV !== "development",
    strategy: "memory",
    ttl: 60000, // å¼€å‘ç¯å¢ƒï¼š1åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰ï¼Œå¿«é€Ÿåˆ·æ–°
  },
});
```

**ä¼˜åŠ¿**ï¼š

- âœ… å¼€å‘æ—¶å¿«é€Ÿåˆ·æ–°é…ç½®
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¾ƒé•¿ TTL æå‡æ€§èƒ½

#### 4. å¤šè¿›ç¨‹åº”ç”¨

ä½¿ç”¨æ–‡ä»¶ç¼“å­˜åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«é…ç½®ï¼š

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [directoryLoader({ directory: "./config" })],
  cache: {
    enabled: true,
    strategy: "file",
    cacheDir: "./cache", // å…±äº«ç¼“å­˜ç›®å½•
    ttl: 3600000, // 1å°æ—¶
  },
});
```

**ä¼˜åŠ¿**ï¼š

- âœ… å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ç¼“å­˜
- âœ… å‡å°‘é‡å¤åŠ è½½å’ŒéªŒè¯
- âœ… ç¼“å­˜æŒä¹…åŒ–ï¼Œè¿›ç¨‹é‡å¯åä»å¯ç”¨

### ä½¿ç”¨æ–¹æ³•

#### åŸºç¡€ç”¨æ³•

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  cache: {
    enabled: true,
    strategy: "memory",
    ttl: 3600000, // 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰
  },
});
```

#### å®Œæ•´é…ç½®é€‰é¡¹

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  cache: {
    // æ˜¯å¦å¯ç”¨ç¼“å­˜
    enabled: true,

    // ç¼“å­˜ç­–ç•¥ï¼šmemoryï¼ˆå†…å­˜ï¼‰| fileï¼ˆæ–‡ä»¶ï¼‰| noneï¼ˆæ— ç¼“å­˜ï¼‰
    strategy: "memory",

    // è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    ttl: 3600000, // 1å°æ—¶

    // ç¼“å­˜é”®å‰ç¼€
    keyPrefix: "config",

    // æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼ˆä»…å†…å­˜ç¼“å­˜ï¼‰
    maxSize: 1000,

    // ç¼“å­˜ç›®å½•ï¼ˆä»…æ–‡ä»¶ç¼“å­˜ï¼‰
    cacheDir: "./cache",
  },
});
```

#### æ–‡ä»¶ç¼“å­˜

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  cache: {
    enabled: true,
    strategy: "file",
    cacheDir: "./cache", // ç¼“å­˜ç›®å½•
    ttl: 3600000, // 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰
  },
});
```

#### ç¦ç”¨ç¼“å­˜

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  cache: {
    enabled: false, // æˆ– strategy: "none"
  },
});
```

### é«˜çº§ç”¨æ³•

#### ä½¿ç”¨ CacheManager æ‰‹åŠ¨ç®¡ç†ç¼“å­˜

å¦‚æœéœ€è¦æ‰‹åŠ¨ç®¡ç†ç¼“å­˜ï¼Œå¯ä»¥æ³¨å…¥ `CacheManager`ï¼š

```typescript
import { CacheManager } from "@hl8/config";
import { Injectable } from "@nestjs/common";

@Injectable()
export class ConfigService {
  constructor(private readonly cacheManager: CacheManager) {}

  async clearCache() {
    // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
    await this.cacheManager.clear();
  }

  async getCacheStats() {
    // è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
    return await this.cacheManager.getStats();
  }

  async invalidateConfig(key: string) {
    // åˆ é™¤æŒ‡å®šé…ç½®çš„ç¼“å­˜
    await this.cacheManager.delete(key);
  }

  async hasCache(key: string) {
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨
    return await this.cacheManager.has(key);
  }
}
```

#### ç¼“å­˜äº‹ä»¶ç›‘å¬

```typescript
import { CacheManager } from "@hl8/config";

const cacheManager = new CacheManager({
  enabled: true,
  strategy: "memory",
});

// ç›‘å¬ç¼“å­˜å‘½ä¸­äº‹ä»¶
cacheManager.on("hit", (event) => {
  console.log(`ç¼“å­˜å‘½ä¸­: ${event.key}`, event.timestamp);
});

// ç›‘å¬ç¼“å­˜æœªå‘½ä¸­äº‹ä»¶
cacheManager.on("miss", (event) => {
  console.log(`ç¼“å­˜æœªå‘½ä¸­: ${event.key}`, event.timestamp);
});

// ç›‘å¬ç¼“å­˜è¿‡æœŸäº‹ä»¶
cacheManager.on("expire", (event) => {
  console.log(`ç¼“å­˜è¿‡æœŸ: ${event.key}`, event.timestamp);
});
```

#### ç¼“å­˜ç»Ÿè®¡

```typescript
import { CacheManager } from "@hl8/config";

const cacheManager = new CacheManager({
  enabled: true,
  strategy: "memory",
});

// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
const stats = await cacheManager.getStats();

console.log(`ç¼“å­˜å‘½ä¸­ç‡: ${stats.hitRate}%`);
console.log(`æ€»ç¼“å­˜æ¡ç›®: ${stats.totalEntries}`);
console.log(`ç¼“å­˜å¤§å°: ${stats.totalSize} bytes`);
console.log(`å¹³å‡è®¿é—®æ—¶é—´: ${stats.averageAccessTime} ms`);
console.log(`æœ€å¸¸è®¿é—®çš„é”®:`, stats.topKeys);
```

**ç»Ÿè®¡ä¿¡æ¯è¯´æ˜**ï¼š

| å­—æ®µ                | è¯´æ˜                 | ç±»å‹                                    |
| ------------------- | -------------------- | --------------------------------------- |
| `totalEntries`      | æ€»ç¼“å­˜æ¡ç›®æ•°         | `number`                                |
| `hits`              | ç¼“å­˜å‘½ä¸­æ¬¡æ•°         | `number`                                |
| `misses`            | ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°       | `number`                                |
| `hitRate`           | ç¼“å­˜å‘½ä¸­ç‡ï¼ˆ0-100ï¼‰  | `number`                                |
| `totalSize`         | æ€»ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰   | `number`                                |
| `averageAccessTime` | å¹³å‡è®¿é—®æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `number`                                |
| `topKeys`           | æœ€å¸¸è®¿é—®çš„é”®åˆ—è¡¨     | `Array<{ key: string; count: number }>` |

### æ³¨æ„äº‹é¡¹

1. **å†…å­˜ç¼“å­˜**ï¼šä»…åœ¨è¿›ç¨‹å†…æœ‰æ•ˆï¼Œè¿›ç¨‹é‡å¯åç¼“å­˜ä¸¢å¤±
2. **æ–‡ä»¶ç¼“å­˜**ï¼šéœ€è¦ç¡®ä¿ç¼“å­˜ç›®å½•æœ‰è¯»å†™æƒé™
3. **TTL è®¾ç½®**ï¼šæ ¹æ®é…ç½®æ›´æ–°é¢‘ç‡åˆç†è®¾ç½® TTLï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
4. **ç¼“å­˜å¤±æ•ˆ**ï¼šé…ç½®æ›´æ–°åéœ€è¦æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜æˆ–ç­‰å¾… TTL è¿‡æœŸ
5. **ç¼“å­˜é”®**ï¼šä½¿ç”¨ `keyPrefix` é¿å…ä¸åŒåº”ç”¨ä¹‹é—´çš„ç¼“å­˜é”®å†²çª

### æœ€ä½³å®è·µ

#### âœ… æ¨èåšæ³•

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œè®¾ç½®è¾ƒé•¿çš„ TTLï¼ˆ1å°æ—¶ä»¥ä¸Šï¼‰
2. **å¼€å‘ç¯å¢ƒ**ï¼šç¦ç”¨ç¼“å­˜æˆ–ä½¿ç”¨è¾ƒçŸ­çš„ TTLï¼ˆ1-5åˆ†é’Ÿï¼‰
3. **è¿œç¨‹é…ç½®**ï¼šå¯ç”¨ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
4. **å¤šè¿›ç¨‹åº”ç”¨**ï¼šä½¿ç”¨æ–‡ä»¶ç¼“å­˜ï¼Œå…±äº«é…ç½®

#### âŒ é¿å…åšæ³•

1. âŒ åœ¨ç”Ÿäº§ç¯å¢ƒç¦ç”¨ç¼“å­˜ï¼ˆå½±å“æ€§èƒ½ï¼‰
2. âŒ è®¾ç½®è¿‡çŸ­çš„ TTLï¼ˆé¢‘ç¹é‡æ–°åŠ è½½ï¼‰
3. âŒ åœ¨å¤šè¿›ç¨‹åº”ç”¨ä¸­ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼ˆæ— æ³•å…±äº«ï¼‰
4. âŒ å¿½ç•¥ç¼“å­˜ç›®å½•æƒé™ï¼ˆæ–‡ä»¶ç¼“å­˜å¤±è´¥ï¼‰

---

## å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å®Œæ•´çš„åº”ç”¨é…ç½®

**é…ç½®ç±»** (`src/config/app.config.ts`):

```typescript
import { Type } from "class-transformer";
import { IsString, IsNumber, IsBoolean, IsOptional, ValidateNested, IsIn, Min, Max } from "class-validator";

export class DatabaseConfig {
  @IsString()
  @IsNotEmpty()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  @Min(1)
  @Max(65535)
  public readonly port!: number;

  @IsString()
  @IsNotEmpty()
  public readonly name!: string;

  @IsString()
  @IsOptional()
  public readonly username?: string;

  @IsString()
  @IsOptional()
  public readonly password?: string;
}

export class RedisConfig {
  @IsString()
  @IsNotEmpty()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly port!: number;
}

export class LoggingConfig {
  @IsString()
  @IsIn(["debug", "info", "warn", "error"])
  public readonly level!: string;

  @IsBoolean()
  @Type(() => Boolean)
  public readonly prettyPrint!: boolean;
}

export class AppConfig {
  @IsString()
  @IsIn(["development", "production", "test"])
  @IsOptional()
  public readonly NODE_ENV: string = "development";

  @IsNumber()
  @Type(() => Number)
  @IsOptional()
  public readonly PORT: number = 3000;

  @ValidateNested()
  @Type(() => DatabaseConfig)
  public readonly database!: DatabaseConfig;

  @ValidateNested()
  @Type(() => RedisConfig)
  @IsOptional()
  public readonly redis?: RedisConfig;

  @ValidateNested()
  @Type(() => LoggingConfig)
  public readonly logging!: LoggingConfig;
}
```

**æ¨¡å—é…ç½®** (`src/app.module.ts`):

```typescript
import { TypedConfigModule, dotenvLoader, directoryLoader } from "@hl8/config";
import { Module } from "@nestjs/common";
import * as path from "path";
import { AppConfig } from "./config/app.config.js";

@Module({
  imports: [
    TypedConfigModule.forRoot({
      schema: AppConfig,
      isGlobal: true,
      load: [
        // 1. ä»é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆä¼˜å…ˆï¼‰
        // å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒdirectoryLoader è¿”å›ç©ºå¯¹è±¡ï¼Œä¸ä¼šæŠ¥é”™
        directoryLoader({
          directory: path.join(process.cwd(), "config"),
        }),
        // 2. ä»ç¯å¢ƒå˜é‡åŠ è½½ï¼ˆä½œä¸º fallbackï¼‰
        // æ³¨æ„ï¼šåªä½¿ç”¨è¿›ç¨‹ç¯å¢ƒå˜é‡ï¼Œä¸åŠ è½½ .env æ–‡ä»¶
        // .env æ–‡ä»¶åº”è¯¥åªåœ¨æ²¡æœ‰å…¶ä»–é…ç½®æºæ—¶æ‰ä½¿ç”¨
        dotenvLoader({
          separator: "__",
          ignoreEnvFile: true, // å¿½ç•¥ .env æ–‡ä»¶ï¼Œåªä½¿ç”¨è¿›ç¨‹ç¯å¢ƒå˜é‡
          enableExpandVariables: true,
        }),
      ],
    }),
  ],
})
export class AppModule {}
```

**é…ç½®æ–‡ä»¶** (`config/default.json`):

```json
{
  "NODE_ENV": "development",
  "PORT": 3000,
  "database": {
    "host": "localhost",
    "port": 5432,
    "name": "mydb"
  },
  "logging": {
    "level": "info",
    "prettyPrint": true
  }
}
```

**ç¯å¢ƒå˜é‡** (`.env`):

```bash
# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=8080

# æ•°æ®åº“é…ç½®
DATABASE__HOST=${DB_HOST:-localhost}
DATABASE__PORT=5432
DATABASE__NAME=${DB_NAME:-mydb}
DATABASE__USERNAME=${DB_USER}
DATABASE__PASSWORD=${DB_PASSWORD}

# Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
REDIS__HOST=redis-server
REDIS__PORT=6379

# æ—¥å¿—é…ç½®
LOGGING__LEVEL=info
LOGGING__PRETTY_PRINT=false
```

**ä½¿ç”¨é…ç½®**:

```typescript
import { Injectable } from "@nestjs/common";
import { AppConfig } from "./config/app.config.js";

@Injectable()
export class DatabaseService {
  constructor(private readonly config: AppConfig) {}

  async connect() {
    const { database } = this.config;

    console.log(`è¿æ¥åˆ°æ•°æ®åº“: ${database.host}:${database.port}`);
    console.log(`æ•°æ®åº“åç§°: ${database.name}`);

    // å®Œå…¨ç±»å‹å®‰å…¨
    if (database.username) {
      console.log(`ç”¨æˆ·å: ${database.username}`);
    }
  }
}
```

### æ¡ˆä¾‹ 2: å¤šç¯å¢ƒé…ç½®

**ç›®å½•ç»“æ„**:

```
config/
  â”œâ”€â”€ default.json
  â”œâ”€â”€ development.json
  â”œâ”€â”€ production.json
  â””â”€â”€ test.json
```

**é»˜è®¤é…ç½®** (`config/default.json`):

```json
{
  "PORT": 3000,
  "database": {
    "host": "localhost",
    "port": 5432
  }
}
```

**å¼€å‘ç¯å¢ƒ** (`config/development.json`):

```json
{
  "NODE_ENV": "development",
  "database": {
    "name": "dev_db"
  },
  "logging": {
    "level": "debug",
    "prettyPrint": true
  }
}
```

**ç”Ÿäº§ç¯å¢ƒ** (`config/production.json`):

```json
{
  "NODE_ENV": "production",
  "database": {
    "name": "prod_db"
  },
  "logging": {
    "level": "info",
    "prettyPrint": false
  }
}
```

**æ¨¡å—é…ç½®**:

```typescript
import { TypedConfigModule, directoryLoader, dotenvLoader } from "@hl8/config";
import * as path from "path";

TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [
    // åŠ è½½æ‰€æœ‰é…ç½®æ–‡ä»¶
    directoryLoader({
      directory: path.join(process.cwd(), "config"),
    }),
    // ç¯å¢ƒå˜é‡è¦†ç›–
    dotenvLoader({
      separator: "__",
    }),
  ],
});
```

**ä½¿ç”¨**:

```bash
# å¼€å‘ç¯å¢ƒ
NODE_ENV=development npm start

# ç”Ÿäº§ç¯å¢ƒ
NODE_ENV=production npm start
```

### æ¡ˆä¾‹ 3: è¿œç¨‹é…ç½®

```typescript
import { TypedConfigModule, remoteLoader, dotenvLoader } from "@hl8/config";

TypedConfigModule.forRootAsync({
  schema: AppConfig,
  load: [
    // ä»è¿œç¨‹é…ç½®ä¸­å¿ƒåŠ è½½
    remoteLoader("https://config-server.com/api/config", {
      requestConfig: {
        headers: {
          Authorization: `Bearer ${process.env.CONFIG_TOKEN}`,
        },
        timeout: 5000,
      },
      retries: 3,
      retryInterval: 1000,
    }),
    // æœ¬åœ°ç¯å¢ƒå˜é‡è¦†ç›–
    dotenvLoader({
      separator: "__",
    }),
  ],
});
```

---

## æœ€ä½³å®è·µ

### 1. é…ç½®ç±»è®¾è®¡

#### âœ… æ¨èåšæ³•

```typescript
// å•ä¸€èŒè´£ - æ¯ä¸ªé…ç½®ç±»åªè´Ÿè´£ä¸€ä¸ªé¢†åŸŸ
export class DatabaseConfig {
  @IsString()
  public readonly host!: string;

  @IsNumber()
  @Type(() => Number)
  public readonly port!: number;
}

export class AppConfig {
  @ValidateNested()
  @Type(() => DatabaseConfig)
  public readonly database!: DatabaseConfig;
}
```

#### âŒ é¿å…åšæ³•

```typescript
// å°†æ‰€æœ‰é…ç½®æ”¾åœ¨ä¸€ä¸ªç±»ä¸­
export class AppConfig {
  // æ•°æ®åº“é…ç½®
  @IsString()
  public readonly dbHost!: string;

  // Redis é…ç½®
  @IsString()
  public readonly redisHost!: string;

  // æ—¥å¿—é…ç½®
  @IsString()
  public readonly logLevel!: string;
  // ... æ‰€æœ‰é…ç½®æ··åœ¨ä¸€èµ·
}
```

### 2. é…ç½®åŠ è½½é¡ºåº

#### âœ… æ¨èåšæ³•

```typescript
load: [
  // 1. é…ç½®æ–‡ä»¶ï¼ˆä¼˜å…ˆåŠ è½½ï¼‰
  // å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒdirectoryLoader è¿”å›ç©ºå¯¹è±¡ï¼Œä¸ä¼šæŠ¥é”™
  directoryLoader({ directory: "./config" }),

  // 2. è¿œç¨‹é…ç½®æºï¼ˆå¦‚æœéœ€è¦ï¼‰
  // remoteLoader("https://config-server.com/api/config", {
  //   requestConfig: {
  //     headers: { Authorization: "Bearer token" },
  //   },
  // }),

  // 3. ç¯å¢ƒå˜é‡ï¼ˆä½œä¸ºæœ€åçš„ fallbackï¼‰
  // æ³¨æ„ï¼šåªä½¿ç”¨è¿›ç¨‹ç¯å¢ƒå˜é‡ï¼Œä¸åŠ è½½ .env æ–‡ä»¶
  // .env æ–‡ä»¶åº”è¯¥åªåœ¨æ²¡æœ‰å…¶ä»–é…ç½®æºæ—¶æ‰ä½¿ç”¨
  dotenvLoader({
    separator: "__",
    ignoreEnvFile: true, // å¿½ç•¥ .env æ–‡ä»¶ï¼Œåªä½¿ç”¨è¿›ç¨‹ç¯å¢ƒå˜é‡
  }),
];
```

**é…ç½®åŠ è½½ä¼˜å…ˆçº§**ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **é…ç½®æ–‡ä»¶**ï¼ˆJSON/YAMLï¼‰- ä¼˜å…ˆåŠ è½½
2. **è¿œç¨‹é…ç½®æº** - å¦‚æœé…ç½®äº†è¿œç¨‹é…ç½®æœåŠ¡
3. **è¿›ç¨‹ç¯å¢ƒå˜é‡** - ä½œä¸ºæœ€åçš„ fallback
4. **.env æ–‡ä»¶** - ä»…åœ¨æ— æ³•è·å¾—å…¶ä»–é…ç½®æºæ—¶ä½¿ç”¨

**é‡è¦è¯´æ˜**ï¼š

- é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä¼šç»§ç»­å°è¯•å…¶ä»–é…ç½®æº
- `.env` æ–‡ä»¶åªåœ¨æ²¡æœ‰å…¶ä»–é…ç½®æºæ—¶ä½œä¸º fallback
- `.env` æ–‡ä»¶ä¸å­˜åœ¨æ—¶é™é»˜å¿½ç•¥ï¼Œä¸ä¼šå½±å“åº”ç”¨å¯åŠ¨
- è¿›ç¨‹ç¯å¢ƒå˜é‡å§‹ç»ˆå¯ç”¨ï¼Œä½œä¸ºæœ€åçš„é…ç½®æº

### 3. ç¯å¢ƒå˜é‡å‘½å

#### âœ… æ¨èåšæ³•

```bash
# ä½¿ç”¨ __ ä½œä¸ºåµŒå¥—åˆ†éš”ç¬¦
DATABASE__HOST=localhost
DATABASE__PORT=5432
LOGGING__LEVEL=info
LOGGING__PRETTY_PRINT=true
```

#### âŒ é¿å…åšæ³•

```bash
# ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿æˆ–é©¼å³°å‘½å
DATABASE_HOST=localhost  # ä¸ä¼šè¢«è§£æä¸ºåµŒå¥—
databaseHost=localhost   # ä¸ä¼šè¢«è§£æä¸ºåµŒå¥—
```

### 4. é»˜è®¤å€¼å¤„ç†

#### âœ… æ¨èåšæ³•

```typescript
// åœ¨é…ç½®ç±»ä¸­è®¾ç½®é»˜è®¤å€¼
export class AppConfig {
  @IsString()
  @IsOptional()
  public readonly NODE_ENV: string = "development";

  @IsNumber()
  @Type(() => Number)
  @IsOptional()
  public readonly PORT: number = 3000;
}
```

æˆ–è€…ä½¿ç”¨å˜é‡æ‰©å±•ï¼š

```yaml
# config/default.yml
database:
  host: ${DB_HOST:-localhost}
  port: ${DB_PORT:-5432}
```

### 5. ç±»å‹è½¬æ¢

#### âœ… é‡è¦ï¼šå­—ç¬¦ä¸²è½¬æ•°å­—

```typescript
export class AppConfig {
  @IsNumber()
  @Type(() => Number) // å¿…é¡»æ·»åŠ æ­¤è£…é¥°å™¨
  public readonly port!: number;
}
```

ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ä¸­çš„æ•°å­—éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¿…é¡»ä½¿ç”¨ `@Type(() => Number)` è½¬æ¢ã€‚

#### âœ… å­—ç¬¦ä¸²è½¬å¸ƒå°”å€¼

```typescript
export class AppConfig {
  @IsBoolean()
  @Type(() => Boolean) // å¿…é¡»æ·»åŠ æ­¤è£…é¥°å™¨
  public readonly enabled!: boolean;
}
```

### 6. é…ç½®éªŒè¯

#### âœ… æ¨èåšæ³•

```typescript
export class AppConfig {
  @IsNumber()
  @Type(() => Number)
  @Min(1)
  @Max(65535)
  @IsOptional()
  public readonly port: number = 3000;
}
```

å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯ï¼Œé…ç½®é”™è¯¯ç«‹å³å‘ç°ã€‚

### 7. æ•æ„Ÿä¿¡æ¯å¤„ç†

#### âœ… æ¨èåšæ³•

```typescript
// ä¸è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯
// ä½¿ç”¨ç¯å¢ƒå˜é‡
export class DatabaseConfig {
  @IsString()
  @IsOptional()
  public readonly password?: string; // ä»ç¯å¢ƒå˜é‡åŠ è½½
}
```

```bash
# .envï¼ˆä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
DATABASE__PASSWORD=secret123
```

### 8. å¤šç¯å¢ƒé…ç½®

#### âœ… æ¨èåšæ³•

```
config/
  â”œâ”€â”€ default.json      # é€šç”¨é…ç½®
  â”œâ”€â”€ development.json  # å¼€å‘ç¯å¢ƒ
  â”œâ”€â”€ production.json   # ç”Ÿäº§ç¯å¢ƒ
  â””â”€â”€ test.json         # æµ‹è¯•ç¯å¢ƒ
```

ä½¿ç”¨ `directoryLoader` è‡ªåŠ¨åŠ è½½ï¼Œæˆ–ä½¿ç”¨ `NODE_ENV` ç¯å¢ƒå˜é‡é€‰æ‹©é…ç½®æ–‡ä»¶ã€‚

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆé…ç½®å±æ€§æ˜¯ `undefined`ï¼Ÿ

**åŸå› **ï¼šé…ç½®å±æ€§æ²¡æœ‰æ­£ç¡®åŠ è½½æˆ–å‘½åä¸åŒ¹é…ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ç¯å¢ƒå˜é‡å‘½åæ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨ `__` åˆ†éš”ç¬¦ï¼‰
2. æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é…ç½®ç±»å±æ€§åæ˜¯å¦åŒ¹é…
4. ç¡®ä¿ä½¿ç”¨äº†æ­£ç¡®çš„è£…é¥°å™¨ï¼ˆ`@Type(() => Number)` ç­‰ï¼‰

### Q2: æ•°å­—ç±»å‹é…ç½®ä¸ºä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²ï¼Ÿ

**åŸå› **ï¼šç¯å¢ƒå˜é‡å’Œ JSON ä¸­çš„æ•°å­—éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
@IsNumber()
@Type(() => Number) // å¿…é¡»æ·»åŠ æ­¤è£…é¥°å™¨
public readonly port!: number;
```

### Q3: å¦‚ä½•è°ƒè¯•é…ç½®åŠ è½½é—®é¢˜ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. å¯ç”¨è°ƒè¯•æ—¥å¿—
2. æ£€æŸ¥é…ç½®åŠ è½½é¡ºåºï¼ˆé…ç½®æ–‡ä»¶ â†’ è¿œç¨‹é…ç½® â†’ ç¯å¢ƒå˜é‡ï¼‰
3. éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
4. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
5. ç¡®è®¤é…ç½®æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆä¸å­˜åœ¨æ—¶ä¼šè¿”å›ç©ºå¯¹è±¡ï¼Œä¸ä¼šæŠ¥é”™ï¼‰

### Q4: é…ç½®éªŒè¯å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**åŸå› **ï¼šé…ç½®å€¼ä¸ç¬¦åˆéªŒè¯è§„åˆ™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æŸ¥çœ‹è¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥é…ç½®å€¼æ˜¯å¦ç¬¦åˆè£…é¥°å™¨è¦æ±‚
3. ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½æœ‰å€¼
4. æ£€æŸ¥ç±»å‹è½¬æ¢æ˜¯å¦æ­£ç¡®

### Q5: å¦‚ä½•æ”¯æŒå¤šç¯å¢ƒé…ç½®ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
load: [fileLoader({ path: `./config/${process.env.NODE_ENV || "development"}.json` }), dotenvLoader()];
```

æˆ–ä½¿ç”¨ `directoryLoader` åŠ è½½æ‰€æœ‰é…ç½®æ–‡ä»¶ã€‚

### Q6: å˜é‡æ‰©å±•ä¸å·¥ä½œï¼Ÿ

**åŸå› **ï¼šæœªå¯ç”¨å˜é‡æ‰©å±•æˆ–è¯­æ³•é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¡®ä¿ `enableExpandVariables: true`
2. æ£€æŸ¥å˜é‡è¯­æ³•ï¼š`${VAR}` æˆ– `${VAR:-DEFAULT}`
3. ç¡®ä¿å¼•ç”¨çš„ç¯å¢ƒå˜é‡å·²è®¾ç½®

---

## è¿›é˜¶ä¸»é¢˜

### 1. å¼‚æ­¥é…ç½®åŠ è½½

```typescript
TypedConfigModule.forRootAsync({
  schema: AppConfig,
  load: [
    async () => {
      // å¼‚æ­¥åŠ è½½é…ç½®
      const response = await fetch("https://config-server.com/api/config");
      return await response.json();
    },
  ],
});
```

### 2. è‡ªå®šä¹‰é…ç½®è½¬æ¢

```typescript
TypedConfigModule.forRoot({
  schema: AppConfig,
  load: [...],
  transform: (config) => {
    // è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
    return {
      ...config,
      computed: `${config.host}:${config.port}`,
    };
  },
})
```

### 3. é…ç½®çƒ­æ›´æ–°

```typescript
// é‡æ–°åŠ è½½é…ç½®
const configService = app.get(TypedConfigService);
await configService.reload();
```

### 4. é…ç½®æä¾›è€…

```typescript
// æ³¨å…¥é…ç½®æä¾›è€…
constructor(
  @Inject(AppConfig) private readonly config: AppConfig,
  @Inject(DatabaseConfig) private readonly dbConfig: DatabaseConfig,
) {}
```

### 5. é…ç½®ç›‘å¬

```typescript
// ç›‘å¬é…ç½®å˜åŒ–
configService.onConfigChange((config) => {
  console.log("é…ç½®å·²æ›´æ–°", config);
});
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. âœ… **ç±»å‹å®‰å…¨** - ä½¿ç”¨ TypeScript ç±»å’Œè£…é¥°å™¨å®šä¹‰é…ç½®
2. âœ… **å¤šåŠ è½½å™¨** - æ”¯æŒæ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹é…ç½®
3. âœ… **æ™ºèƒ½ fallback** - é…ç½®æ–‡ä»¶ä¼˜å…ˆï¼Œç¯å¢ƒå˜é‡ä½œä¸º fallback
4. âœ… **å˜é‡æ‰©å±•** - æ”¯æŒ `${VAR}` å’Œ `${VAR:-DEFAULT}` è¯­æ³•
5. âœ… **è‡ªåŠ¨éªŒè¯** - åŸºäº class-validator çš„é…ç½®éªŒè¯
6. âœ… **é…ç½®ç¼“å­˜** - å†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œæå‡æ€§èƒ½

### å­¦ä¹ è·¯å¾„

1. **åŸºç¡€** - é…ç½®ç±»å®šä¹‰ã€åŸºç¡€åŠ è½½å™¨
2. **è¿›é˜¶** - åµŒå¥—é…ç½®ã€å˜é‡æ‰©å±•ã€å¤šç¯å¢ƒ
3. **é«˜çº§** - è‡ªå®šä¹‰éªŒè¯ã€è¿œç¨‹é…ç½®ã€é…ç½®çƒ­æ›´æ–°

### å‚è€ƒèµ„æº

- [é¡¹ç›® README](./README.md)
- [NestJS å®˜æ–¹æ–‡æ¡£](https://docs.nestjs.com/)
- [class-validator æ–‡æ¡£](https://github.com/typestack/class-validator)
- [class-transformer æ–‡æ¡£](https://github.com/typestack/class-transformer)

---

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå¸¸è§é—®é¢˜éƒ¨åˆ†æˆ–æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ã€‚
